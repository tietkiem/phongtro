<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tìm Phòng Trọ Nhanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f2f5; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
        .listing-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .listing-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .gallery-scroll::-webkit-scrollbar { height: 8px; }
        .gallery-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .gallery-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .gallery-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none; }
        #login-view { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #drop-zone.dragover { border-color: #2563eb; background-color: #eff6ff; }
        .image-preview-item { position: relative; }
        .delete-image-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; border: 1px solid white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; line-height: 1; }
        .offcanvas-panel { transition: transform 0.3s ease-in-out; }
        .gallery-nav-btn { transition: background-color 0.2s, opacity 0.2s; }
        .filter-dropdown { position: relative; }
        .filter-dropdown-content { display: none; position: absolute; background-color: white; min-width: 220px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; }
        .filter-dropdown-content.show { display: block; }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-view" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-sm bg-white rounded-xl shadow-2xl p-8">
            <div class="text-center mb-8"><i class="fas fa-house-user text-5xl text-blue-600"></i><h2 class="mt-4 text-2xl font-bold text-gray-800">Đăng Nhập Admin</h2></div>
            <div class="space-y-4">
                <div><label for="username" class="block text-sm font-medium text-gray-700">Tên đăng nhập</label><input type="text" id="username" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2"></div>
                <div><label for="password" class="block text-sm font-medium text-gray-700">Mật khẩu</label><input type="password" id="password" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2"></div>
                <p id="login-error" class="text-red-500 text-sm hidden">Tên đăng nhập hoặc mật khẩu không đúng.</p>
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Đăng Nhập</button>
                <button id="back-to-main-from-login" class="mt-2 w-full text-center text-sm text-gray-600 hover:text-blue-600">Quay về trang chủ</button>
            </div>
        </div>
    </div>

    <div id="main-view">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="text-left"><h1 class="text-2xl font-bold text-blue-600"><i class="fas fa-house-chimney-window mr-2"></i>Tìm Phòng Trọ</h1><p class="text-sm text-gray-500 italic -mt-1">Tìm trọ miễn phí - An tâm lựa chọn.</p></div>
                <div class="hidden lg:flex items-center gap-4">
                    <div class="relative"><input type="search" id="search-input-desktop" placeholder="Tìm theo địa chỉ, mã nhà..." class="border border-gray-300 rounded-lg pl-10 pr-4 py-2 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                    <div class="flex items-center gap-2"><label for="sort-price-desktop" class="text-sm font-medium"><i class="fas fa-dollar-sign mr-1"></i>Giá:</label><select id="sort-price-desktop" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="newest">Mới nhất</option><option value="asc">Tăng dần</option><option value="desc">Giảm dần</option></select></div>
                    <div class="flex items-center gap-2"><label for="filter-ward-desktop" class="text-sm font-medium"><i class="fas fa-map-marker-alt mr-1"></i>Phường:</label><select id="filter-ward-desktop" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="all">Tất cả</option></select></div>
                    
                    <div class="filter-dropdown"><button id="utility-filter-btn-desktop" class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex items-center gap-2"><i class="fas fa-star mr-1"></i>Tiện ích <i class="fas fa-chevron-down text-xs ml-1"></i></button><div id="utility-filter-desktop-container" class="filter-dropdown-content grid grid-cols-2 gap-x-4 gap-y-2"></div></div>
                    
                    <div class="flex items-center gap-2"><label class="text-sm font-medium"><i class="fas fa-toggle-on mr-1"></i>Trạng thái:</label><select id="filter-status-desktop" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="all">Tất cả</option><option value="Chưa cho thuê">Chưa cho thuê</option><option value="Đã cho thuê">Đã cho thuê</option></select></div>
                    <button id="go-to-admin-btn-desktop" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-user-shield mr-2"></i>Admin</button>
                </div>
                <div class="lg:hidden"><button id="open-filter-btn" class="p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400"><i class="fas fa-bars text-xl"></i></button></div>
            </div>
        </header>
        <main class="container mx-auto p-4">
            <div id="listings-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="col-span-full text-center text-gray-500 py-10"><i class="fas fa-spinner fa-spin text-3xl"></i><p>Đang tải dữ liệu...</p></div>
            </div>
        </main>
    </div>

    <div id="filter-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="filter-panel" class="offcanvas-panel fixed top-0 left-0 w-4/5 max-w-sm h-full bg-white z-50 shadow-lg p-6 transform -translate-x-full overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-4"><h2 class="text-xl font-bold">Lọc & Tìm Kiếm</h2><button id="close-filter-btn" class="p-2 text-2xl font-bold">&times;</button></div>
        <div class="space-y-4">
            <div><label for="search-input-mobile" class="text-sm font-medium text-gray-700">Tìm địa chỉ, mã nhà</label><div class="relative mt-1"><input type="search" id="search-input-mobile" placeholder="Nhập từ khóa..." class="border border-gray-300 rounded-lg pl-10 pr-4 py-2 text-sm w-full focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div></div>
            <div><label for="sort-price-mobile" class="text-sm font-medium text-gray-700">Sắp xếp theo giá</label><select id="sort-price-mobile" class="border border-gray-300 rounded-lg px-3 py-2 text-sm mt-1 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="newest">Mới nhất</option><option value="asc">Tăng dần</option><option value="desc">Giảm dần</option></select></div>
            <div><label for="filter-ward-mobile" class="text-sm font-medium text-gray-700">Lọc theo phường</label><select id="filter-ward-mobile" class="border border-gray-300 rounded-lg px-3 py-2 text-sm mt-1 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="all">Tất cả</option></select></div>
            <div><label class="text-sm font-medium text-gray-700">Lọc theo tiện ích</label><div id="utility-filter-mobile-container" class="mt-2 grid grid-cols-2 gap-x-4 gap-y-2 border p-3 rounded-md"></div></div>
            <div><label for="filter-status-mobile" class="text-sm font-medium text-gray-700">Lọc theo trạng thái</label><select id="filter-status-mobile" class="border border-gray-300 rounded-lg px-3 py-2 text-sm mt-1 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="all">Tất cả</option><option value="Chưa cho thuê">Chưa cho thuê</option><option value="Đã cho thuê">Đã cho thuê</option></select></div>
        </div>
        <div class="border-t pt-6 mt-6"><button id="go-to-admin-btn-mobile" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-user-shield mr-2"></i>Trang Admin</button></div>
    </div>

    <div id="admin-view" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 md:p-8">
            <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl p-6">
                <div class="flex flex-wrap justify-between items-center mb-6 border-b pb-4 gap-4"><h2 class="text-2xl font-bold text-gray-800">Trang Quản Trị</h2><div class="flex items-center gap-4"><button id="go-to-main-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-arrow-left mr-2"></i>Về Trang Chủ</button><button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất</button></div></div>
                <div class="mb-8 p-4 bg-purple-50 border border-purple-200 rounded-lg"><h3 class="text-lg font-semibold text-purple-800 mb-2"><i class="fas fa-cloud-upload-alt mr-2"></i>Cài đặt Cloudinary (Chỉ cần làm 1 lần)</h3><p class="text-sm text-gray-600 mb-2">Để upload ảnh, bạn cần cung cấp thông tin tài khoản Cloudinary. Xem hướng dẫn <a href="https://cloudinary.com/documentation/upload_presets" target="_blank" class="text-blue-600 underline">tại đây</a> để tạo <strong>Upload Preset (Unsigned)</strong>.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="cloudinary-cloud-name" class="block text-sm font-medium text-gray-700">Cloud Name</label><input type="text" id="cloudinary-cloud-name" placeholder="Tên cloud của bạn" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div><div><label for="cloudinary-upload-preset" class="block text-sm font-medium text-gray-700">Upload Preset Name</label><input type="text" id="cloudinary-upload-preset" placeholder="Tên upload preset" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div></div><button id="save-cloudinary-settings-btn" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-save mr-2"></i>Lưu Cài Đặt</button></div>
                <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg"><h3 class="text-lg font-semibold text-blue-800 mb-2"><i class="fas fa-magic mr-2"></i>Công cụ Bóc tách Dữ liệu</h3><textarea id="data-parser-input" class="w-full h-32 border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm" placeholder="Dán nội dung tin đăng vào đây..."></textarea><button id="parse-data-btn" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Bóc tách dữ liệu</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label for="admin-code" class="block text-sm font-medium text-gray-700">Mã nhà</label><input type="text" id="admin-code" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="admin-address" class="block text-sm font-medium text-gray-700">Địa chỉ</label><input type="text" id="admin-address" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="admin-ward" class="block text-sm font-medium text-gray-700">Phường</label><input type="text" id="admin-ward" list="wards-datalist" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"><datalist id="wards-datalist"></datalist></div>
                    <div><label for="admin-price" class="block text-sm font-medium text-gray-700">Giá phòng (VND)</label><input type="number" id="admin-price" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="admin-area" class="block text-sm font-medium text-gray-700">Diện tích (m²)</label><input type="number" id="admin-area" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="admin-elevator" class="block text-sm font-medium text-gray-700">Thang máy</label><select id="admin-elevator" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"><option>Không</option><option>Có</option></select></div>
                    <div><label for="admin-wc" class="block text-sm font-medium text-gray-700">Vệ sinh</label><select id="admin-wc" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"><option>Khép kín</option><option>Chung</option></select></div>
                    <div><label for="admin-electricity" class="block text-sm font-medium text-gray-700">Giá điện (VND/kWh)</label><input type="number" id="admin-electricity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="admin-water" class="block text-sm font-medium text-gray-700">Giá nước</label><div class="mt-1 flex rounded-md shadow-sm"><input type="number" id="admin-water" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 p-2" placeholder="VD: 30000"><select id="admin-water-unit" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm"><option value="khoi">/ khối</option><option value="nguoi">/ người</option></select></div></div>
                    <div><label for="admin-service-fee" class="block text-sm font-medium text-gray-700">Phí dịch vụ (VND/người)</label><input type="number" id="admin-service-fee" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="admin-internet" class="block text-sm font-medium text-gray-700">Giá mạng (VND/phòng)</label><input type="number" id="admin-internet" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Trạng thái</label><button type="button" id="admin-status-btn" class="mt-1 w-full text-left px-3 py-2 rounded-md font-bold bg-green-100 text-green-700 border border-green-300">Chưa cho thuê</button></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Các tiện ích</label><div id="admin-utilities" class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 border p-3 rounded-md"></div></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Ảnh phòng trọ</label><div id="drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md transition-colors duration-300"><div class="space-y-1 text-center"><i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i><div class="flex text-sm text-gray-600"><label for="admin-images" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none"><span>Tải lên ảnh mới</span><input id="admin-images" type="file" class="sr-only" multiple accept="image/*"></label><p class="pl-1">hoặc kéo và thả</p></div><p class="text-xs text-gray-500">Các ảnh mới sẽ được thêm vào cuối danh sách.</p></div></div></div>
                    <div id="image-preview-container" class="md:col-span-2 mt-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 bg-gray-50 p-2 rounded-md border min-h-[80px]"></div>
                </div>
                <div class="mt-8 pt-5 border-t"><button id="submit-listing-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-lg"><i class="fas fa-plus-circle mr-2"></i><span id="submit-btn-text">Thêm Tin Đăng Mới</span><i id="submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i></button></div>
                <div class="mt-10 pt-6 border-t-2 border-dashed border-gray-300">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-list-alt mr-2"></i>Quản lý Tin đăng hiện tại</h3></div>
                    <div class="relative mb-4"><input type="search" id="admin-search-input" placeholder="Tìm tin đăng để sửa/xóa..." class="w-full border-gray-300 rounded-md shadow-sm p-2 pl-10 focus:ring-blue-500 focus:border-blue-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                    <div id="admin-listings-container" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                <div class="mt-10 pt-6 border-t-2 border-dashed border-gray-300">
                    <div class="p-4 bg-green-50 border border-green-300 rounded-lg"><h3 class="text-lg font-semibold text-green-800 mb-2"><i class="fas fa-cogs mr-2"></i>Công Cụ Cập Nhật Website</h3><p class="text-sm text-gray-600 mb-2">Sau khi đã thêm/xóa/sửa tin, nhấn nút bên dưới để lưu và xuất bản các thay đổi lên website.</p><ol class="list-decimal list-inside text-sm space-y-1"><li>Thực hiện các thay đổi (thêm/xóa/sửa tin).</li><li>Nhấn nút <strong>"Lưu và Xuất Bản Lên GitHub"</strong>.</li><li>Chờ khoảng 1-2 phút để website của bạn tự động cập nhật.</li></ol><button id="publish-to-github-btn" class="mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center"><i class="fab fa-github mr-2"></i>Lưu và Xuất Bản Lên GitHub</button><p id="publish-status" class="text-sm mt-2"></p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="listing-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
            <button id="close-listing-modal" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center text-xl z-20">&times;</button>
            <div class="p-4 flex-grow overflow-y-auto">
                <div id="gallery-section" class="relative mb-4"><img id="main-gallery-image" src="" alt="Ảnh phòng trọ" class="w-full h-[60vh] object-contain rounded-md mb-2 bg-gray-100 cursor-pointer"><button id="gallery-prev-btn" class="gallery-nav-btn absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-30 hover:bg-opacity-60 text-white rounded-full w-10 h-10 flex items-center justify-center text-2xl">&#10094;</button><button id="gallery-next-btn" class="gallery-nav-btn absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-30 hover:bg-opacity-60 text-white rounded-full w-10 h-10 flex items-center justify-center text-2xl">&#10095;</button><div id="thumbnail-gallery-container" class="flex gap-2 overflow-x-auto pb-2 gallery-scroll"></div></div>
                <div id="details-section" class="p-4 border-t"></div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6"><h3 id="confirm-modal-title" class="text-lg font-bold text-gray-800">Xác nhận hành động</h3><p id="confirm-modal-text" class="text-sm text-gray-600 mt-2">Bạn có chắc chắn muốn thực hiện hành động này?</p><div class="mt-6 flex justify-end gap-3"><button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button id="confirm-modal-ok" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Xác nhận</button></div></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const FACEBOOK_USERNAME = "nhatrohanoi25";
        const ZALO_PHONE_NUMBER = "0936018987";

        let listingsData = [], listingsMap = new Map(), sessionListings = [], uploadedFiles = [], currentEditImages = [];
        let authToken = null, currentGalleryImages = [], currentGalleryIndex = 0, currentEditId = null;
        let adminStatus = false;
        const ALL_UTILITIES = ['Điều hòa', 'Nóng lạnh', 'Máy giặt', 'Giường', 'Tủ đồ', 'Bếp', 'Tủ lạnh', 'Ban công', 'Gác xép'];

        const allViews = { login: document.getElementById('login-view'), main: document.getElementById('main-view'), admin: document.getElementById('admin-view') };
        const grid = document.getElementById('listings-grid');
        const searchInputDesktop = document.getElementById('search-input-desktop');
        const sortPriceDesktop = document.getElementById('sort-price-desktop');
        const filterWardDesktop = document.getElementById('filter-ward-desktop');
        const utilityFilterBtnDesktop = document.getElementById('utility-filter-btn-desktop');
        const utilityFilterDesktopContainer = document.getElementById('utility-filter-desktop-container');
        const filterStatusDesktop = document.getElementById('filter-status-desktop');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const sortPriceMobile = document.getElementById('sort-price-mobile');
        const filterWardMobile = document.getElementById('filter-ward-mobile');
        const utilityFilterMobileContainer = document.getElementById('utility-filter-mobile-container');
        const filterStatusMobile = document.getElementById('filter-status-mobile');
        const adminListingsContainer = document.getElementById('admin-listings-container');
        const adminUtilities = document.getElementById('admin-utilities');
        const adminStatusBtn = document.getElementById('admin-status-btn');
        const adminForm = { code: document.getElementById('admin-code'), address: document.getElementById('admin-address'), ward: document.getElementById('admin-ward'), price: document.getElementById('admin-price'), area: document.getElementById('admin-area'), wc: document.getElementById('admin-wc'), elevator: document.getElementById('admin-elevator'), electricity: document.getElementById('admin-electricity'), water: document.getElementById('admin-water'), serviceFee: document.getElementById('admin-service-fee'), internet: document.getElementById('admin-internet'), images: document.getElementById('admin-images') };
        // Các DOM element khác
        const goToAdminBtnDesktop = document.getElementById('go-to-admin-btn-desktop');
        const goToAdminBtnMobile = document.getElementById('go-to-admin-btn-mobile');

        async function loadListings() { try { const response = await fetch(`data.json?v=${new Date().getTime()}`); if (!response.ok) throw new Error(`Network: ${response.statusText}`); const data = await response.json(); listingsData = data; sessionListings = JSON.parse(JSON.stringify(data)); listingsMap = new Map(data.map(item => [item.id, item])); updateAndRender(); populateWards(); populateUtilityCheckboxes(); } catch (error) { console.error('Could not fetch listings data:', error); grid.innerHTML = `<p class="col-span-full text-center text-red-500">Lỗi tải dữ liệu. Vui lòng kiểm tra file data.json và làm mới trang.</p>`; } }
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        
        function renderListings(data) {
            grid.innerHTML = '';
            if (data.length === 0) { grid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">Không tìm thấy phòng trọ nào phù hợp.</p>`; return; }
            data.forEach(listing => {
                const card = document.createElement('div');
                card.className = 'listing-card bg-white rounded-lg shadow-lg overflow-hidden cursor-pointer';
                card.setAttribute('data-id', listing.id);
                const statusText = listing.status || 'Chưa cho thuê';
                const statusColor = statusText === 'Đã cho thuê' ? 'bg-red-500' : 'bg-green-500';
                card.innerHTML = `<div class="relative"><img src="${listing.images[0]}" alt="Ảnh phòng trọ" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Lỗi+Ảnh';"><div class="absolute top-2 right-2 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded">${listing.ward}</div><div class="absolute bottom-2 left-2 px-2 py-1 rounded text-xs font-bold ${statusColor} text-white">${statusText}</div></div><div class="p-4"><p class="font-bold text-lg text-red-500">${formatCurrency(listing.price)}/tháng</p><p class="text-sm text-gray-600 truncate"><i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>${listing.address}</p><div class="flex flex-wrap gap-1 mt-2">${(listing.utilities || []).slice(0, 3).map(u => `<span class="bg-gray-200 text-xs px-2 py-1 rounded">${u}</span>`).join('')}</div></div>`;
                grid.appendChild(card);
            });
        }
        
        function updateAndRender() {
            let filteredData = [...(authToken ? sessionListings : listingsData)];
            const searchTerm = searchInputDesktop.value.toLowerCase().trim();
            if (searchTerm) { filteredData = filteredData.filter(item => item.address.toLowerCase().includes(searchTerm) || (item.code && item.code.toLowerCase().includes(searchTerm))); }
            if (filterWardDesktop.value !== 'all') { filteredData = filteredData.filter(item => item.ward === filterWardDesktop.value); }
            if (filterStatusDesktop.value !== 'all') { filteredData = filteredData.filter(item => (item.status || 'Chưa cho thuê') === filterStatusDesktop.value); }
            const selectedUtilities = Array.from(document.querySelectorAll('#utility-filter-desktop-container input:checked, #utility-filter-mobile-container input:checked')).map(cb => cb.value);
            if (selectedUtilities.length > 0) { filteredData = filteredData.filter(item => selectedUtilities.every(util => (item.utilities || []).includes(util))); }
            const sortBy = sortPriceDesktop.value;
            if (sortBy === 'asc') filteredData.sort((a, b) => a.price - b.price); else if (sortBy === 'desc') filteredData.sort((a, b) => b.price - a.price); else filteredData.sort((a, b) => b.timestamp - a.timestamp);
            renderListings(filteredData);
        }

        function updateGalleryView() { const mainImg = document.getElementById('main-gallery-image'); if (!currentGalleryImages || currentGalleryImages.length === 0) return; mainImg.src = currentGalleryImages[currentGalleryIndex]; document.getElementById('gallery-prev-btn').style.display = currentGalleryIndex === 0 ? 'none' : 'flex'; document.getElementById('gallery-next-btn').style.display = currentGalleryIndex === currentGalleryImages.length - 1 ? 'none' : 'flex'; document.querySelectorAll('#thumbnail-gallery-container img').forEach((thumb, index) => thumb.classList.toggle('border-blue-500', index === currentGalleryIndex)); }
        
        function showListingModal(listingId) {
            const listing = listingsMap.get(listingId); if (!listing) return;
            const detailsSection = document.getElementById('details-section'); const thumbnailContainer = document.getElementById('thumbnail-gallery-container'); const mainGalleryImage = document.getElementById('main-gallery-image');
            currentGalleryImages = listing.images; currentGalleryIndex = 0; thumbnailContainer.innerHTML = '';
            if (currentGalleryImages && currentGalleryImages.length > 0) { currentGalleryImages.forEach((imgSrc, index) => { const thumb = document.createElement('img'); thumb.src = imgSrc; thumb.className = `w-24 h-16 object-cover rounded-md cursor-pointer border-2 border-transparent`; thumb.onclick = () => { currentGalleryIndex = index; updateGalleryView(); }; thumbnailContainer.appendChild(thumb); }); } else { mainGalleryImage.src = 'https://placehold.co/800x600/cccccc/ffffff?text=Không+có+ảnh'; }
            updateGalleryView();
            const waterPriceText = listing.water > 0 ? (listing.waterUnit === 'nguoi' ? formatCurrency(listing.water) + '/người' : formatCurrency(listing.water) + '/khối') : 'Miễn phí';
            const facebookMessageLink = `https://m.me/${FACEBOOK_USERNAME}?ref=${encodeURIComponent(`Quan tâm phòng ${listing.code} - ${listing.address}`)}`;
            const zaloLink = `https://zalo.me/${ZALO_PHONE_NUMBER}`;
            const statusText = listing.status || 'Chưa cho thuê'; const statusColor = statusText === 'Đã cho thuê' ? 'bg-red-500' : 'bg-green-500';
            detailsSection.innerHTML = `<h2 class="text-2xl font-bold mb-2 text-blue-700">${listing.address}</h2><p class="text-lg font-semibold text-red-600 mb-4">${formatCurrency(listing.price)}/tháng</p><div class="flex flex-wrap gap-2 mb-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor} text-white">${statusText}</span>${(listing.utilities || []).map(u => `<span class="bg-gray-200 text-xs px-2 py-1 rounded">${u}</span>`).join('')}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700"><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-ruler-combined mr-2"></i>Diện tích:</strong> ${listing.area} m²</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-toilet mr-2"></i>Vệ sinh:</strong> ${listing.wc}</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-elevator mr-2"></i>Thang máy:</strong> ${listing.elevator || 'Không'}</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-concierge-bell mr-2"></i>Phí dịch vụ:</strong> ${listing.serviceFee > 0 ? formatCurrency(listing.serviceFee) + '/người' : 'Miễn phí'}</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-bolt mr-2"></i>Giá điện:</strong> ${listing.electricity > 0 ? formatCurrency(listing.electricity) + '/kWh' : 'Miễn phí'}</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-tint mr-2"></i>Giá nước:</strong> ${waterPriceText}</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-wifi mr-2"></i>Giá mạng:</strong> ${listing.internet > 0 ? formatCurrency(listing.internet) + '/phòng' : 'Miễn phí'}</div><div class="bg-gray-100 p-3 rounded-lg"><strong><i class="fas fa-barcode mr-2"></i>Mã nhà:</strong> ${listing.code}</div></div><div class="mt-6 pt-4 border-t flex flex-col gap-2"><a href="${zaloLink}" target="_blank" class="inline-block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center text-lg"><i class="fas fa-comment-dots mr-2"></i>Nhắn tin Zalo</a><a href="${facebookMessageLink}" target="_blank" class="inline-block w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-center text-lg"><i class="fab fa-facebook-messenger mr-2"></i>Nhắn tin Facebook</a></div>`;
            document.getElementById('listing-modal').classList.remove('hidden');
        }
        
        function populateWards() { const wards = [...new Set(listingsData.map(item => item.ward).filter(Boolean))].sort(); const wardFilters = [filterWardDesktop, filterWardMobile]; wardFilters.forEach(f => { f.innerHTML = '<option value="all">Tất cả</option>'; wards.forEach(w => f.innerHTML += `<option value="${w}">${w}</option>`); }); document.getElementById('wards-datalist').innerHTML = wards.map(w => `<option value="${w}"></option>`).join(''); }
        function populateUtilityCheckboxes() { [utilityFilterDesktopContainer, utilityFilterMobileContainer].forEach(container => { container.innerHTML = ''; ALL_UTILITIES.forEach(util => { const label = document.createElement('label'); label.className = 'flex items-center space-x-2 text-sm cursor-pointer'; label.innerHTML = `<input type="checkbox" value="${util}" class="utility-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500"><span class="select-none">${util}</span>`; container.appendChild(label); }); }); }
        
        function handleGoToAdmin() { if (authToken) { switchView('admin'); renderAdminListings(); } else { switchView('login'); } }
        function switchView(view) { Object.values(allViews).forEach(v => v.classList.add('hidden')); allViews[view].classList.remove('hidden'); window.scrollTo(0, 0); }
        async function uploadToCloudinary(files) { const settings = JSON.parse(localStorage.getItem('cloudinarySettings')); if (!settings || !settings.cloudName || !settings.uploadPreset) { throw new Error('Chưa cài đặt Cloudinary.'); } const { cloudName, uploadPreset } = settings; const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`; const uploadPromises = files.map(file => { const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', uploadPreset); return fetch(url, { method: 'POST', body: formData }).then(response => response.json()); }); const results = await Promise.all(uploadPromises); return results.map(result => { if (result.secure_url) return result.secure_url; throw new Error(`Upload thất bại: ${result.error.message}`); }); }
        
        async function handleAdminSubmit() {
            const requiredFields = ['code', 'address', 'ward', 'price', 'area'];
            for (const field of requiredFields) { if (!adminForm[field].value) { alert(`Vui lòng điền thông tin: ${adminForm[field].previousElementSibling.textContent}`); return; } }
            if ((!currentEditId && uploadedFiles.length === 0) || (currentEditId && currentEditImages.length === 0 && uploadedFiles.length === 0)) { alert('Tin đăng phải có ít nhất một ảnh.'); return; }
            const submitListingBtn = document.getElementById('submit-listing-btn'); submitListingBtn.disabled = true; document.getElementById('submit-spinner').classList.remove('hidden');
            try {
                let newImageUrls = [];
                if (uploadedFiles.length > 0) { document.getElementById('submit-btn-text').textContent = 'Đang upload ảnh...'; newImageUrls = await uploadToCloudinary(uploadedFiles); }
                document.getElementById('submit-btn-text').textContent = 'Đang lưu...';
                const listingData = {
                    code: adminForm.code.value, address: adminForm.address.value, ward: adminForm.ward.value, price: parseInt(adminForm.price.value), area: parseInt(adminForm.area.value), wc: adminForm.wc.value, elevator: adminForm.elevator.value, electricity: parseInt(adminForm.electricity.value) || 0, water: parseInt(adminForm.water.value) || 0, waterUnit: document.getElementById('admin-water-unit')?.value || 'khoi', serviceFee: parseInt(adminForm.serviceFee.value) || 0, internet: parseInt(adminForm.internet.value) || 0,
                    utilities: Array.from(adminUtilities.querySelectorAll('input:checked')).map(cb => cb.value), status: adminStatus ? "Đã cho thuê" : "Chưa cho thuê"
                };
                if (currentEditId) {
                    const index = sessionListings.findIndex(l => l.id === currentEditId);
                    if (index > -1) { Object.assign(sessionListings[index], { ...listingData, images: [...currentEditImages, ...newImageUrls], timestamp: Date.now() }); alert('Cập nhật thành công!'); }
                } else { sessionListings.push({ ...listingData, images: newImageUrls, id: 'P' + Date.now(), timestamp: Date.now() }); alert('Thêm mới thành công!'); }
                clearAdminForm(); renderAdminListings(); populateWards();
            } catch (error) { console.error("Lỗi:", error); alert(`Đã xảy ra lỗi: ${error.message}`);
            } finally { submitListingBtn.disabled = false; document.getElementById('submit-spinner').classList.add('hidden'); document.getElementById('submit-btn-text').textContent = 'Thêm Tin Đăng Mới'; }
        }

        function clearAdminForm() { Object.values(adminForm).forEach(input => { if (input.type !== 'select-one') input.value = ''; }); document.getElementById('admin-water-unit').value = 'khoi'; document.getElementById('image-preview-container').innerHTML = ''; document.getElementById('data-parser-input').value = ''; uploadedFiles = []; currentEditImages = []; currentEditId = null; document.getElementById('submit-btn-text').textContent = 'Thêm Tin Đăng Mới'; adminForm.images.value = ''; adminStatus = false; if (adminStatusBtn) { adminStatusBtn.textContent = "Chưa cho thuê"; adminStatusBtn.className = "mt-1 w-full text-left px-3 py-2 rounded-md font-bold bg-green-100 text-green-700 border border-green-300"; } if (adminUtilities) adminUtilities.querySelectorAll('input').forEach(cb => cb.checked = false); }
        function renderAdminListings(searchTerm = '') { adminListingsContainer.innerHTML = ''; let listings = [...sessionListings]; if (searchTerm) { listings = listings.filter(l => l.address.toLowerCase().includes(searchTerm) || l.code.toLowerCase().includes(searchTerm)); } listings.sort((a, b) => b.timestamp - a.timestamp).forEach(l => { const item = document.createElement('div'); item.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-md'; item.innerHTML = `<div class="flex-grow truncate pr-4"><p class="text-sm font-medium">${l.address}</p><p class="text-xs text-gray-500">${l.ward} - ${formatCurrency(l.price)}</p></div><div class="flex-shrink-0 flex gap-2"><button data-id="${l.id}" class="edit-listing-btn bg-blue-500 text-white w-8 h-8 rounded-md hover:bg-blue-600 flex items-center justify-center" title="Sửa"><i class="fas fa-pencil-alt"></i></button><button data-id="${l.id}" class="delete-listing-btn bg-red-500 text-white w-8 h-8 rounded-md hover:bg-red-600 flex items-center justify-center" title="Xóa"><i class="fas fa-trash"></i></button></div>`; adminListingsContainer.appendChild(item); }); }
        function renderAdminImagePreviews() { const container = document.getElementById('image-preview-container'); container.innerHTML = ''; currentEditImages.forEach((imageUrl, index) => { const item = document.createElement('div'); item.className = 'image-preview-item'; item.innerHTML = `<img src="${imageUrl}" class="w-full h-24 object-cover rounded-md"><button data-index="${index}" data-type="existing" class="delete-image-btn">&times;</button>`; container.appendChild(item); }); uploadedFiles.forEach((file, index) => { const item = document.createElement('div'); item.className = 'image-preview-item'; item.innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-full h-24 object-cover rounded-md border-2 border-green-500"><button data-index="${index}" data-type="new" class="delete-image-btn">&times;</button>`; container.appendChild(item); }); }
        
        function handleEditListing(listingId) {
            const listing = sessionListings.find(l => l.id === listingId); if (!listing) return; clearAdminForm(); currentEditId = listingId;
            Object.keys(adminForm).forEach(key => { if(listing[key] !== undefined && adminForm[key]) adminForm[key].value = listing[key]; });
            adminStatus = listing.status === "Đã cho thuê";
            adminStatusBtn.textContent = adminStatus ? "Đã cho thuê" : "Chưa cho thuê";
            adminStatusBtn.className = `mt-1 w-full text-left px-3 py-2 rounded-md font-bold ${adminStatus ? 'bg-red-100 text-red-700 border-red-300' : 'bg-green-100 text-green-700 border-green-300'}`;
            adminUtilities.querySelectorAll('input').forEach(cb => { cb.checked = (listing.utilities || []).includes(cb.value); });
            currentEditImages = [...(listing.images || [])];
            renderAdminImagePreviews(); document.getElementById('submit-btn-text').textContent = 'Cập Nhật Tin Đăng';
            window.scrollTo({ top: document.getElementById('admin-view').offsetTop, behavior: 'smooth' });
        }
        function populateAdminUtilities() { if (!adminUtilities) return; adminUtilities.innerHTML = ''; ALL_UTILITIES.forEach(util => { const label = document.createElement('label'); label.className = 'flex items-center space-x-2 text-sm cursor-pointer'; label.innerHTML = `<input type="checkbox" value="${util}" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500"><span class="select-none">${util}</span>`; adminUtilities.appendChild(label); }); }

        // --- EVENT LISTENERS ---
        document.body.addEventListener('click', e => {
            if (e.target.closest('#utility-filter-btn-desktop')) { utilityFilterDesktopContainer.classList.toggle('show'); return; }
            if (!e.target.closest('#utility-filter-desktop-container')) { utilityFilterDesktopContainer.classList.remove('show'); }
            const card = e.target.closest('.listing-card'); if (card) showListingModal(card.dataset.id);
            const editBtn = e.target.closest('.edit-listing-btn'); if(editBtn) handleEditListing(editBtn.dataset.id);
            const deleteBtn = e.target.closest('.delete-listing-btn'); if(deleteBtn) { /* Xử lý xóa */ }
            const deleteImgBtn = e.target.closest('.delete-image-btn'); if(deleteImgBtn) { const { index, type } = deleteImgBtn.dataset; if(type === 'existing') currentEditImages.splice(index, 1); else uploadedFiles.splice(index, 1); renderAdminImagePreviews(); }
        });
        
        ['input', 'change'].forEach(evt => document.body.addEventListener(evt, e => {
            const target = e.target;
            const isFilter = target.closest('#main-view header, #filter-panel') && (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.type === 'checkbox');
            if (isFilter) {
                if(target.id.includes('mobile')) { document.getElementById(target.id.replace('mobile', 'desktop')).value = target.value; }
                else if(target.id.includes('desktop') && target.type !== 'checkbox') { document.getElementById(target.id.replace('desktop', 'mobile')).value = target.value; }
                updateAndRender();
            }
        }));

        adminStatusBtn.addEventListener('click', () => { adminStatus = !adminStatus; adminStatusBtn.textContent = adminStatus ? "Đã cho thuê" : "Chưa cho thuê"; adminStatusBtn.className = `mt-1 w-full text-left px-3 py-2 rounded-md font-bold ${adminStatus ? 'bg-red-100 text-red-700 border-red-300' : 'bg-green-100 text-green-700 border-green-300'}`; });
        goToAdminBtnDesktop.addEventListener('click', handleGoToAdmin);
        goToAdminBtnMobile.addEventListener('click', handleGoToAdmin);
        document.getElementById('parse-data-btn').addEventListener('click', () => { /* Logic bóc tách dữ liệu */ });
        document.getElementById('submit-listing-btn').addEventListener('click', handleAdminSubmit);
        document.getElementById('go-to-main-btn').addEventListener('click', () => switchView('main'));
        document.getElementById('admin-images').addEventListener('change', (e) => { uploadedFiles.push(...e.target.files); renderAdminImagePreviews(); });

        // --- KHỞI TẠO ---
        loadListings();
        populateAdminUtilities();
        switchView('main');
    });
    </script>
</body>
</html>