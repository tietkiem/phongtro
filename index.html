<script>
    document.addEventListener('DOMContentLoaded', () => {
        let listingsData = [];
        let listingsMap = new Map();
        let sessionListings = [];
        let uploadedFiles = [];
        
        // BIẾN MỚI: Dùng để lưu "vé vào cửa"
        let authToken = null;

        // --- DOM ELEMENTS (giữ nguyên) ---
        const allViews = { login: document.getElementById('login-view'), main: document.getElementById('main-view'), admin: document.getElementById('admin-view') };
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        // ... (các element khác giữ nguyên)

        // --- CÁC HÀM KHÁC (giữ nguyên từ loadListings đến showConfirmModal) ---
        // ... (dán tất cả các hàm cũ của bạn vào đây)
        
        // --- EVENT LISTENERS ---

        // THAY ĐỔI: Logic nút Đăng Nhập
        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            loginBtn.disabled = true;
            loginError.classList.add('hidden');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Lỗi không xác định.');
                }
                
                // Lưu "vé vào cửa"
                authToken = data.token;
                
                // Chuyển sang trang admin
                switchView('admin');
                loadCloudinarySettings();
                renderAdminListings();
                usernameInput.value = '';
                passwordInput.value = '';

            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
            }
        });

        // THAY ĐỔI: Logic nút Đăng Xuất
        logoutBtn.addEventListener('click', () => {
            authToken = null; // Xóa "vé"
            switchView('main');
        });
        
        // THAY ĐỔI: Logic nút Trang Admin
        const handleGoToAdmin = () => {
            // Chỉ vào được nếu có "vé"
            if (authToken) {
                switchView('admin');
                renderAdminListings();
            } else {
                switchView('login');
            }
            if (!filterPanel.classList.contains('-translate-x-full')) {
                toggleFilterMenu();
            }
        };

        // ... (Các event listener khác giữ nguyên)

        // THAY ĐỔI: Logic nút Xuất Bản
        publishBtn.addEventListener('click', async () => {
            // Kiểm tra xem có "vé" không
            if (!authToken) {
                alert("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.");
                switchView('login');
                return;
            }

            const isConfirmed = confirm("Bạn có chắc chắn muốn xuất bản dữ liệu không?");
            if (!isConfirmed) return;

            publishStatus.textContent = 'Đang kết nối và xuất bản...';
            publishBtn.disabled = true;

            try {
                const dataString = JSON.stringify(sessionListings, null, 2);
                
                const response = await fetch('/api/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Gửi kèm "vé vào cửa"
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: dataString,
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Lỗi không xác định từ server.');
                }

                publishStatus.textContent = 'Xuất bản thành công! Website sẽ được cập nhật sau vài phút.';
                listingsData = JSON.parse(JSON.stringify(sessionListings));
                listingsMap = new Map(listingsData.map(item => [item.id, item]));

            } catch (error) {
                publishStatus.textContent = `Xuất bản thất bại: ${error.message}`;
            } finally {
                publishBtn.disabled = false;
            }
        });

        // --- KHỞI TẠO ---
        loadListings();
        switchView('main');
    });
</script>