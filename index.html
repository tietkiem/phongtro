<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m Ki·∫øm Ph√≤ng Tr·ªç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .transition-all { transition: all 0.3s ease-in-out; }
        #modal-container.hidden, .tab-content.hidden, #form-modal-container.hidden, #login-modal-container.hidden { display: none; }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn { background-color: #eef2ff; color: #4f46e5; }
        .gallery-thumbnail { cursor: pointer; border: 2px solid transparent; }
        .gallery-thumbnail.active { border-color: #4f46e5; }
        .thumbnail-selector {
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .thumbnail-selector.selected {
            border-color: #4f46e5;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <div class="flex justify-between items-center mb-8 border-b border-slate-200 pb-4">
            <div class="text-xl font-bold text-indigo-600">PhongTro.VIP</div>
            <div class="flex items-center space-x-2">
                <div id="tab-container" class="flex p-1 bg-slate-100 rounded-lg">
                    <button id="tab-home" class="tab-btn active font-semibold py-2 px-4 md:px-6 rounded-md transition-all">Trang Ch·ªß</button>
                    <button id="tab-admin" class="tab-btn font-semibold py-2 px-4 md:px-6 rounded-md transition-all hidden">Admin</button>
                </div>
                <button id="login-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition-all">ƒêƒÉng Nh·∫≠p</button>
                <button id="logout-btn" class="hidden bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-all">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>

        <div id="content-home" class="tab-content">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold">T√¨m Ph√≤ng Tr·ªç ∆Øng √ù</h1>
                <p class="text-slate-500 mt-2">N·ªÅn t·∫£ng t√¨m ki·∫øm v√† cho thu√™ ph√≤ng tr·ªç nhanh ch√≥ng, minh b·∫°ch.</p>
            </header>
            <div id="search-filters" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-slate-700 mb-1">ƒê·ªãa ch·ªâ, t√™n t√≤a nh√†</label>
                        <input type="text" id="searchInput" placeholder="VD: C·∫ßu Gi·∫•y, L√°ng H·∫°..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="priceFilter" class="block text-sm font-medium text-slate-700 mb-1">Kho·∫£ng gi√°</label>
                        <select id="priceFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="0-3000000">D∆∞·ªõi 3 tri·ªáu</option>
                            <option value="3000000-5000000">3 - 5 tri·ªáu</option>
                            <option value="5000000-7000000">5 - 7 tri·ªáu</option>
                            <option value="7000000-999999999">Tr√™n 7 tri·ªáu</option>
                        </select>
                    </div>
                    <div>
                        <label for="areaFilter" class="block text-sm font-medium text-slate-700 mb-1">Di·ªán t√≠ch (m¬≤)</label>
                        <select id="areaFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="0-20">D∆∞·ªõi 20 m¬≤</option>
                            <option value="20-30">20 - 30 m¬≤</option>
                            <option value="30-40">30 - 40 m¬≤</option>
                            <option value="40-999">Tr√™n 40 m¬≤</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 lg:col-span-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Ti·ªán √≠ch</label>
                        <div id="amenities-filter" class="flex flex-wrap gap-x-4 gap-y-2"></div>
                    </div>
                </div>
            </div>
            <div id="listings-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="no-results" class="hidden text-center py-12"><p class="text-slate-500 text-lg">Kh√¥ng t√¨m th·∫•y ph√≤ng n√†o ph√π h·ª£p.</p></div>
        </div>

        <div id="content-admin" class="tab-content hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold">B·∫£ng ƒêi·ªÅu Khi·ªÉn</h1>
                <p class="text-slate-500 mt-2">Qu·∫£n l√Ω danh s√°ch c√°c t√≤a nh√† v√† ph√≤ng tr·ªç.</p>
            </header>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-4">C√¥ng c·ª• nh·∫≠p nhanh t·ª´ Zalo</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <label for="zalo-input" class="block text-sm font-medium text-slate-700 mb-1">1. D√°n n·ªôi dung Zalo v√†o ƒë√¢y:</label>
                        <textarea id="zalo-input" rows="15" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="D√°n to√†n b·ªô n·ªôi dung tin nh·∫Øn..."></textarea>
                        <button id="parse-btn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all">X·ª≠ L√Ω & Xem Tr∆∞·ªõc</button>
                    </div>
                    <div id="zalo-parser-preview" class="hidden">
                        <h3 class="text-lg font-semibold mb-2">2. Xem tr∆∞·ªõc th√¥ng tin:</h3>
                        <div id="preview-content" class="p-4 bg-slate-50 border border-slate-200 rounded-lg text-sm mb-4"></div>
                        
                        <h3 class="text-lg font-semibold mb-2">3. D√°n link ·∫¢nh/Video (m·ªói link m·ªôt d√≤ng):</h3>
                        <textarea id="zalo-image-links" rows="5" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="https://i.imgur.com/example1.jpg&#10;https://i.imgur.com/example2.jpg"></textarea>

                        <button id="add-parsed-building-btn" class="mt-4 w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-all">4. Th√™m T√≤a Nh√† V√†o H·ªá Th·ªëng</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center my-6 pt-6 border-t">
                <h2 class="text-2xl font-semibold">Qu·∫£n l√Ω th·ªß c√¥ng</h2>
                <button id="add-building-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-all">Th√™m T√≤a Nh√† M·ªõi</button>
            </div>
            <div id="admin-listings-container" class="space-y-4"></div>
        </div>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"></div>
    <div id="form-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"></div>
    
    <div id="login-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[70]">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <form id="login-form" class="p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center">ƒêƒÉng Nh·∫≠p Admin</h2>
                <div>
                    <label for="username" class="block text-sm font-medium text-slate-700">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-700">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center hidden">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.</p>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

<script>
// =======================================================================
// B·ªò N√ÉO M·ªöI v3.0 - PARSER TH√îNG MINH H∆†N, UPLOAD ·∫¢NH B·∫∞NG LINK
// =======================================================================

// !!! QUAN TR·ªåNG: D√°n link Web App URL c·ªßa b·∫°n v√†o ƒë√¢y !!!
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxylrfjhK0dYVzKkNz1GVJAm-SXpqyolXGP7IHM3DIL5Ubvn0WpKwAVlBIyrr859wweXw/exec'; 

let currentData = [];
let parsedBuildingData = null;
let isSaving = false;

document.addEventListener('DOMContentLoaded', function() {
    let editingContext = null;
    let isLoggedIn = false;

    // --- L·∫§Y C√ÅC PH·∫¶N T·ª¨ HTML ---
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginModalContainer = document.getElementById('login-modal-container');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const zaloInput = document.getElementById('zalo-input');
    const parseBtn = document.getElementById('parse-btn');
    const zaloParserPreview = document.getElementById('zalo-parser-preview');
    const previewContent = document.getElementById('preview-content');
    const addParsedBuildingBtn = document.getElementById('add-parsed-building-btn');
    const tabHome = document.getElementById('tab-home');
    const tabAdmin = document.getElementById('tab-admin');
    const contentHome = document.getElementById('content-home');
    const contentAdmin = document.getElementById('content-admin');
    const searchInput = document.getElementById('searchInput');
    const priceFilter = document.getElementById('priceFilter');
    const areaFilter = document.getElementById('areaFilter');
    const amenitiesContainer = document.getElementById('amenities-filter');
    const listingsContainer = document.getElementById('listings-container');
    const noResultsDiv = document.getElementById('no-results');
    const modalContainer = document.getElementById('modal-container');
    const adminListingsContainer = document.getElementById('admin-listings-container');
    const addBuildingBtn = document.getElementById('add-building-btn');
    const formModalContainer = document.getElementById('form-modal-container');

    // --- H√ÄM GIAO TI·∫æP V·ªöI GOOGLE SHEETS ---
    async function fetchData() {
        showLoading("ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...");
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            currentData = data;
            initializeAll();
        } catch (error) {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng link API ho·∫∑c c√†i ƒë·∫∑t Google Sheets.');
        } finally {
            hideLoading();
        }
    }

    async function saveData() {
        if (isSaving) return;
        isSaving = true;
        showLoading("ƒêang l∆∞u thay ƒë·ªïi...");
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(currentData)
            });
            console.log("Y√™u c·∫ßu l∆∞u ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒëi!");
        } catch (error) {
            console.error('L·ªói khi g·ª≠i y√™u c·∫ßu l∆∞u d·ªØ li·ªáu:', error);
            alert('L∆∞u d·ªØ li·ªáu th·∫•t b·∫°i! Vui l√≤ng th·ª≠ l·∫°i.');
        } finally {
            isSaving = false;
            setTimeout(() => { hideLoading(); }, 1500);
        }
    }
    
    function showLoading(message) {
        let loadingDiv = document.getElementById('loading-overlay');
        if (!loadingDiv) {
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-overlay';
            loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[999]';
            document.body.appendChild(loadingDiv);
        }
        loadingDiv.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-xl text-center"><p class="font-semibold">${message}</p><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mt-2"></div></div>`;
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loading-overlay');
        if (loadingDiv) loadingDiv.remove();
    }

    // --- H·ªÜ TH·ªêNG ƒêƒÇNG NH·∫¨P ---
    const ADMIN_USERNAME = 'mrpro69';
    const ADMIN_PASSWORD = '16051984aZ';

    function updateLoginUI() {
        if (isLoggedIn) {
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            tabAdmin.classList.remove('hidden');
        } else {
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            tabAdmin.classList.add('hidden');
            switchTab('home'); 
        }
    }

    loginBtn.addEventListener('click', () => loginModalContainer.classList.remove('hidden'));
    logoutBtn.addEventListener('click', () => { isLoggedIn = false; updateLoginUI(); });
    loginModalContainer.addEventListener('click', (e) => { if (e.target === loginModalContainer) loginModalContainer.classList.add('hidden'); });
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            isLoggedIn = true;
            loginError.classList.add('hidden');
            loginModalContainer.classList.add('hidden');
            updateLoginUI();
            switchTab('admin'); 
        } else {
            loginError.classList.remove('hidden');
        }
    });

    // --- C√îNG C·ª§ NH·∫¨P NHANH T·ª™ ZALO (N√ÇNG C·∫§P v3.0) ---
    parseBtn.addEventListener('click', () => {
        const text = zaloInput.value;
        if (!text.trim()) { alert('Vui l√≤ng d√°n n·ªôi dung Zalo v√†o √¥.'); return; }
        
        try {
            const building = { id_toa_nha: `building_${Date.now()}`, tenToaNha: "", diaChi: "", viTriMap: "", danhSachPhong: [] };
            const lines = text.split('\n').filter(line => line.trim() !== '');

            const findLine = (keywords) => {
                const lowerKeywords = keywords.map(k => k.toLowerCase());
                return lines.find(l => lowerKeywords.some(k => l.toLowerCase().includes(k)));
            };

            const getVal = (line, separator = ':') => line ? line.split(separator)[1]?.trim() : "";

            // L·∫•y T√™n T√≤a Nh√† t·ª´ "M√£"
            const maNhaLine = findLine(['m√£']);
            const maNhaMatch = maNhaLine ? maNhaLine.match(/m√£\s*(\d+)/i) : null;
            if (maNhaMatch) {
                building.tenToaNha = `T√≤a nh√† M√£ ${maNhaMatch[1]}`;
            }

            // L·∫•y th√¥ng tin chung
            const diaChiLine = findLine(['üè¢', 'ƒë·ªãa ch·ªâ']);
            building.diaChi = getVal(diaChiLine) || 'Ch∆∞a x√°c ƒë·ªãnh';
            if (!building.tenToaNha) { // Fallback n·∫øu kh√¥ng c√≥ M√£
                building.tenToaNha = `T√≤a nh√† t·∫°i ${building.diaChi.split(',')[0] || 'ƒê·ªãa ch·ªâ kh√¥ng r√µ'}`;
            }

            const dienTichLine = findLine(['‚ö°', 'di·ªán t√≠ch']);
            const dienTich = parseInt(dienTichLine?.match(/(\d+)/)?.[0] || '25');

            const noiThatLine = findLine(['üí•', 'n·ªôi th·∫•t']);
            const thongTinChiTiet = noiThatLine ? (text.substring(text.indexOf(noiThatLine)).split('üçÄ')[0] || '').replace(noiThatLine,'').trim() : "N·ªôi th·∫•t ƒë·∫ßy ƒë·ªß.";

            const allTextLower = text.toLowerCase();
            const tienIch = ['ƒëi·ªÅu h√≤a', 'n√≥ng l·∫°nh', 'b·∫øp', 't·ªß l·∫°nh', 'm√°y gi·∫∑t', 'ban c√¥ng', 'thang m√°y', 'ko chung ch·ªß', 'gi·ªù gi·∫•c t·ª± do', 'ƒë∆∞·ª£c nu√¥i pet'].filter(item => allTextLower.includes(item));
            
            let chiPhi = {};
            const phiDvLine = findLine(['üçÄ', 'ph√≠ dv']);
            if (phiDvLine) {
                const feesText = text.substring(text.indexOf(phiDvLine));
                const normalizeFee = (str) => str ? str.replace(/\./g, '').replace('k', '000') : '0';
                const getFeeValue = (regex) => {
                    const match = feesText.match(regex);
                    return match ? new Intl.NumberFormat('vi-VN').format(normalizeFee(match[1])) + match[2] : 'N/A';
                };
                chiPhi['ƒëi·ªán'] = getFeeValue(/ƒëi·ªán\s*([\d.kK]+)\/(s·ªë)/i);
                chiPhi['n∆∞·ªõc'] = getFeeValue(/n∆∞·ªõc\s*([\d.kK]+)\/(ng|ng∆∞·ªùi)/i);
                chiPhi['internet'] = getFeeValue(/(wifi|m·∫°ng)\s*([\d.kK]+)\/(p|ph√≤ng)/i);
                chiPhi['d·ªãch v·ª•'] = getFeeValue(/dv·ª• chung\s*([\d.kK]+)\/(ng|ng∆∞·ªùi|ph√≤ng)/i);
            }

            const cocLine = findLine(['‚ùå', 'l∆∞u √Ω', 'ƒë√≥ng']);
            let datCoc = { soThang: 1, ghiChu: "H·ª£p ƒë·ªìng 6-12 th√°ng" };
            if(cocLine){
                datCoc.ghiChu = cocLine.replace(/‚ùå|l∆∞u √Ω|:/gi, '').trim();
                const cocMatch = cocLine.match(/ƒë√≥ng\s*(\d)\s*c·ªçc\s*(\d)/i);
                if (cocMatch) datCoc.soThang = parseInt(cocMatch[2]);
            }
            
            // X·ª≠ l√Ω ph√≤ng v√† gi√°
            const giaLines = lines.filter(l => l.toLowerCase().includes('gi√°'));
            const trongLine = findLine(['‚è∞', 'tr·ªëng']);
            const allRoomCodes = trongLine ? (trongLine.match(/(p?\d+[a-zA-Z]?)/g) || []) : [];

            if (giaLines.length > 0) {
                if (giaLines.length === 1 && giaLines[0].includes('-')) {
                    const pricesStr = getVal(giaLines[0]);
                    const prices = pricesStr.match(/(\d+tr\d*)/g).map(p => parseFloat(p.replace('tr', '.')) * 1000000);
                    allRoomCodes.forEach((code, index) => {
                        const giaThue = prices[index] || prices[prices.length - 1];
                        building.danhSachPhong.push({
                            id_phong: `p_${code}_${Date.now() % 10000}`, tenPhong: `Ph√≤ng ${code}`, trangThai: "c√≤n tr·ªëng",
                            giaThue, dienTich, thongTinChiTiet, tienIch, chiPhi, datCoc, linkAnhVideo: []
                        });
                    });
                } else {
                     giaLines.forEach(line => {
                        const priceMatch = line.match(/(\d+tr\d*)/);
                        if (!priceMatch) return;
                        const giaThue = parseFloat(priceMatch[1].replace('tr', '.')) * 1000000;
                        const roomCodesOnLine = line.split(':')[1]?.match(/(p?\d+[a-zA-Z]?)/g) || [];
                        roomCodesOnLine.forEach(code => {
                             building.danhSachPhong.push({
                                id_phong: `p_${code}_${Date.now() % 10000}`, tenPhong: `Ph√≤ng ${code}`, trangThai: "c√≤n tr·ªëng",
                                giaThue, dienTich, thongTinChiTiet, tienIch, chiPhi, datCoc, linkAnhVideo: []
                            });
                        });
                    });
                }
            }
            
            if(building.danhSachPhong.length === 0){
                throw new Error("Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√≤ng ho·∫∑c gi√° h·ª£p l·ªá.");
            }

            parsedBuildingData = building;
            renderPreview(building);
            zaloParserPreview.classList.remove('hidden');
            document.getElementById('zalo-image-links').value = '';

        } catch (error) {
            alert('X·ª≠ l√Ω d·ªØ li·ªáu th·∫•t b·∫°i! L·ªói: ' + error.message + '. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng vƒÉn b·∫£n.');
            console.error("Parse Zalo Error:", error);
        }
    });

    function renderPreview(building) {
        previewContent.innerHTML = `<p><strong>T√™n t√≤a nh√†:</strong> ${building.tenToaNha}</p><p><strong>T·ªïng s·ªë ph√≤ng s·∫Ω th√™m:</strong> ${building.danhSachPhong.length} ph√≤ng</p>`;
    }
    
    addParsedBuildingBtn.addEventListener('click', async () => {
        if (parsedBuildingData) {
            const imageLinksText = document.getElementById('zalo-image-links').value;
            const imageLinks = imageLinksText.split('\n').map(link => link.trim()).filter(Boolean);
            
            parsedBuildingData.danhSachPhong.forEach(room => { room.linkAnhVideo = [...imageLinks]; });
            if (imageLinks.length > 0) {
                parsedBuildingData.anhDaiDien = imageLinks[0];
            }
            
            currentData.unshift(parsedBuildingData);
            await saveData();
            
            parsedBuildingData = null;
            zaloParserPreview.classList.add('hidden');
            zaloInput.value = '';
            alert('ƒê√£ th√™m v√† l∆∞u t√≤a nh√† m·ªõi th√†nh c√¥ng!');
            refreshAdminView();
            refreshHomeView();
        }
    });
    
    // --- QU·∫¢N L√ù TH·ª¶ C√îNG & FORM ---
    async function handleFormSubmit(e) { e.preventDefault(); const data = {}; const fields = getFormFields(editingContext.type); fields.forEach(field => { const el = document.getElementById(field.id); if (el) setNestedValue(data, field.id, el.value); }); if (editingContext.type === 'building') { if (editingContext.buildingId) { const index = currentData.findIndex(b => b.id_toa_nha === editingContext.buildingId); const oldBuilding = currentData[index]; data.danhSachPhong = oldBuilding.danhSachPhong; currentData[index] = { ...oldBuilding, ...data }; } else { data.id_toa_nha = `building_${Date.now()}`; data.danhSachPhong = []; currentData.unshift(data); } } else if (editingContext.type === 'room') { const building = currentData.find(b => b.id_toa_nha === editingContext.buildingId); if (editingContext.roomId) { const index = building.danhSachPhong.findIndex(r => r.id_phong === editingContext.roomId); building.danhSachPhong[index] = { ...building.danhSachPhong[index], ...data }; } else { data.id_phong = `room_${Date.now()}`; building.danhSachPhong.push(data); } } formModalContainer.classList.add('hidden'); await saveData(); refreshAdminView(); refreshHomeView(); }
    adminListingsContainer.addEventListener('click', async (e) => { const { buildingId, roomId } = e.target.dataset; if (e.target.matches('.edit-building-btn')) openFormModal('building', currentData.find(b => b.id_toa_nha === buildingId), { buildingId }); if (e.target.matches('.delete-building-btn')) { if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t√≤a nh√† n√†y?`)) { currentData = currentData.filter(b => b.id_toa_nha !== buildingId); await saveData(); refreshAdminView(); refreshHomeView(); } } if (e.target.matches('.add-room-btn')) openFormModal('room', {}, { buildingId }); if (e.target.matches('.edit-room-btn')) { const room = currentData.find(b => b.id_toa_nha === buildingId).danhSachPhong.find(r => r.id_phong === roomId); openFormModal('room', room, { buildingId, roomId }); } if (e.target.matches('.delete-room-btn')) { if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng n√†y?`)) { const building = currentData.find(b => b.id_toa_nha === buildingId); building.danhSachPhong = building.danhSachPhong.filter(r => r.id_phong !== roomId); await saveData(); refreshAdminView(); refreshHomeView(); } } });
    
    // --- C√ÅC H√ÄM HI·ªÇN TH·ªä V√Ä H√ÄM PH·ª§ ---
    function openFormModal(type, data = {}, context = {}) { editingContext = { type, ...context }; const isBuilding = type === 'building'; const fields = getFormFields(type); const title = isBuilding ? (data.id_toa_nha ? 'S·ª≠a T√≤a Nh√†' : 'Th√™m T√≤a Nh√†') : (data.id_phong ? 'S·ª≠a Ph√≤ng' : 'Th√™m Ph√≤ng'); const formModalContent = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><form id="admin-form" class="p-6 space-y-4"><h2 class="text-2xl font-bold mb-4">${title}</h2><div id="form-fields">${fields.map(field => renderField(field, data)).join('')}</div><div class="flex justify-end space-x-3 pt-4 border-t"><button type="button" class="cancel-form-btn bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">H·ªßy</button><button type="submit" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700">L∆∞u</button></div></form></div>`; formModalContainer.innerHTML = formModalContent; formModalContainer.classList.remove('hidden'); formModalContainer.querySelector('.cancel-form-btn').addEventListener('click', () => formModalContainer.classList.add('hidden')); formModalContainer.querySelector('#admin-form').addEventListener('submit', handleFormSubmit); if (type === 'building') { document.querySelectorAll('.thumbnail-selector').forEach(thumb => { thumb.addEventListener('click', e => { document.querySelectorAll('.thumbnail-selector').forEach(t => t.classList.remove('selected')); e.currentTarget.classList.add('selected'); document.getElementById('anhDaiDien').value = e.currentTarget.dataset.url; }); }); } }
    function getFormFields(type) { if (type === 'building') return [{ id: 'tenToaNha', label: 'T√™n t√≤a nh√†', type: 'text' }, { id: 'diaChi', label: 'ƒê·ªãa ch·ªâ', type: 'text' }, { id: 'viTriMap', label: 'Link Google Map', type: 'text' }, { id: 'anhDaiDien', label: '·∫¢nh ƒë·∫°i di·ªán', type: 'thumbnail_selector' }]; return [{ id: 'tenPhong', label: 'T√™n ph√≤ng', type: 'text' }, { id: 'trangThai', label: 'Tr·∫°ng th√°i', type: 'select', options: ['c√≤n tr·ªëng', 'ƒë√£ thu√™'] }, { id: 'giaThue', label: 'Gi√° thu√™ (VNƒê)', type: 'number' }, { id: 'dienTich', label: 'Di·ªán t√≠ch (m¬≤)', type: 'number' }, { id: 'thongTinChiTiet', label: 'M√¥ t·∫£ chi ti·∫øt', type: 'textarea' }, { id: 'tienIch', label: 'Ti·ªán √≠ch (c√°ch nhau b·ªüi d·∫•u ph·∫©y)', type: 'text' }, { id: 'linkAnhVideo', label: 'Link ·∫¢nh/Video (m·ªói link m·ªôt d√≤ng)', type: 'textarea' }, { id: 'chiPhi_dien', label: 'Ph√≠ ƒëi·ªán', type: 'text' }, { id: 'chiPhi_nuoc', label: 'Ph√≠ n∆∞·ªõc', type: 'text' }, { id: 'chiPhi_internet', label: 'Ph√≠ Internet', type: 'text' }, { id: 'chiPhi_dichVu', label: 'Ph√≠ d·ªãch v·ª•', type: 'text' }, { id: 'datCoc_soThang', label: 'C·ªçc (s·ªë th√°ng)', type: 'number' }, { id: 'datCoc_ghiChu', label: 'Ghi ch√∫ c·ªçc', type: 'text' }]; }
    function renderField(field, data) { let value = getNestedValue(field.id, data); if (field.id === 'linkAnhVideo' && Array.isArray(value)) { value = value.join('\n'); } switch (field.type) { case 'textarea': return `<label class="block"><span class="text-slate-700">${field.label}</span><textarea id="${field.id}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" rows="4">${value}</textarea></label>`; case 'select': return `<label class="block"><span class="text-slate-700">${field.label}</span><select id="${field.id}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">${field.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('')}</select></label>`; case 'thumbnail_selector': const allImages = (data.danhSachPhong || []).flatMap(room => room.linkAnhVideo || []); if (allImages.length === 0) return `<div><span class="text-slate-700">${field.label}</span><p class="text-sm text-slate-500 mt-1">T√≤a nh√† n√†y ch∆∞a c√≥ ·∫£nh n√†o ƒë·ªÉ ch·ªçn.</p><input type="hidden" id="anhDaiDien" value="${value}"></div>`; return `<div><span class="text-slate-700">${field.label} (Nh·∫•p ƒë·ªÉ ch·ªçn)</span><div class="mt-2 flex flex-wrap gap-2 p-2 border rounded-md bg-slate-50">${allImages.map(url => `<img src="${url}" class="thumbnail-selector w-20 h-20 object-cover rounded-md ${url === value ? 'selected' : ''}" data-url="${url}">`).join('')}</div><input type="hidden" id="anhDaiDien" value="${value}"></div>`; default: return `<label class="block"><span class="text-slate-700">${field.label}</span><input type="${field.type}" id="${field.id}" value="${value}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></label>`; } }
    function getNestedValue(path, obj) { const keys = path.split('_'); let value = obj; for (let key of keys) value = value?.[key]; return value || ''; }
    function setNestedValue(obj, path, value) { const keys = path.split('_'); let current = obj; for (let i = 0; i < keys.length - 1; i++) { current = current[keys[i]] = current[keys[i]] || {}; } const finalKey = keys[keys.length - 1]; if (path === 'linkAnhVideo') { current[finalKey] = value ? value.split('\n').map(s => s.trim()).filter(Boolean) : []; } else if (path === 'tienIch') { current[finalKey] = value ? value.split(',').map(s => s.trim()).filter(Boolean) : []; } else if (['giaThue', 'dienTich', 'datCoc_soThang'].includes(path)) { current[finalKey] = parseFloat(value) || 0; } else { current[finalKey] = value; } }
    const refreshHomeView = () => filterData();
    function filterData() { const keyword = searchInput.value.toLowerCase(); const priceRange = priceFilter.value ? priceFilter.value.split('-').map(Number) : null; const areaRange = areaFilter.value ? areaFilter.value.split('-').map(Number) : null; const selectedAmenities = Array.from(document.querySelectorAll('.amenity-checkbox:checked')).map(cb => cb.value); const filtered = currentData.map(building => { const matchingRooms = (building.danhSachPhong || []).filter(room => { if (room.trangThai !== 'c√≤n tr·ªëng') return false; if (keyword && !`${building.tenToaNha} ${building.diaChi} ${room.tenPhong}`.toLowerCase().includes(keyword)) return false; if (priceRange && (room.giaThue < priceRange[0] || room.giaThue > priceRange[1])) return false; if (areaRange && (room.dienTich < areaRange[0] || room.dienTich > areaRange[1])) return false; if (selectedAmenities.length > 0 && !selectedAmenities.every(a => (room.tienIch || []).includes(a))) return false; return true; }); return matchingRooms.length > 0 ? { ...building, danhSachPhong: matchingRooms } : null; }).filter(Boolean); renderListings(filtered); }
    function renderListings(filteredData) { listingsContainer.innerHTML = ''; noResultsDiv.classList.toggle('hidden', filteredData.length > 0); filteredData.forEach(building => { building.danhSachPhong.forEach(room => { const previewImage = room.linkAnhVideo?.[0] || building.anhDaiDien || 'https://placehold.co/400x300/e2e8f0/64748b?text=Kh√¥ng+c√≥+·∫£nh'; const card = document.createElement('div'); card.className = 'room-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all flex flex-col cursor-pointer'; card.dataset.buildingId = building.id_toa_nha; card.dataset.roomId = room.id_phong; card.innerHTML = `<div class="relative"><img src="${previewImage}" alt="·∫¢nh ph√≤ng" class="w-full h-48 object-cover"></div><div class="p-4 flex-grow flex flex-col"><h3 class="text-base font-bold truncate" title="${room.tenPhong} - ${building.tenToaNha}">${room.tenPhong}</h3><p class="text-sm text-slate-500 mt-1 flex-grow truncate" title="${building.diaChi}">${building.diaChi}</p><div class="flex justify-between items-center mt-2"><span class="text-lg font-bold text-indigo-600">${(room.giaThue / 1000000).toFixed(2).replace('.00','').replace('.50','.5')} tr</span><span class="text-sm text-slate-500">${room.dienTich} m¬≤</span></div></div>`; listingsContainer.appendChild(card); }); }); }
    function refreshAdminView() { adminListingsContainer.innerHTML = (currentData || []).map(building => `<div class="admin-card bg-white p-4 rounded-lg shadow border-2 border-transparent transition-all"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold">${building.tenToaNha}</h3><p class="text-sm text-slate-500">${building.diaChi}</p></div><div class="space-x-2 flex-shrink-0 ml-4"><button class="edit-building-btn text-blue-600 hover:underline" data-building-id="${building.id_toa_nha}">S·ª≠a</button><button class="delete-building-btn text-red-600 hover:underline" data-building-id="${building.id_toa_nha}">X√≥a</button></div></div><div class="mt-4"><h4 class="font-semibold">C√°c ph√≤ng:</h4>${(building.danhSachPhong || []).map(room => `<div class="flex justify-between items-center p-2 bg-slate-50 rounded mt-2"><span>${room.tenPhong} - ${room.trangThai}</span><div class="space-x-2"><button class="edit-room-btn text-sm text-blue-600 hover:underline" data-building-id="${building.id_toa_nha}" data-room-id="${room.id_phong}">S·ª≠a</button><button class="delete-room-btn text-sm text-red-600 hover:underline" data-building-id="${building.id_toa_nha}" data-room-id="${room.id_phong}">X√≥a</button></div></div>`).join('') || '<p class="text-sm text-slate-400 p-2">Ch∆∞a c√≥ ph√≤ng n√†o.</p>'}<button class="add-room-btn mt-3 text-sm w-full text-center bg-slate-200 hover:bg-slate-300 py-2 rounded" data-building-id="${building.id_toa_nha}">+ Th√™m ph√≤ng m·ªõi</button></div></div>`).join(''); }
    const initializeAll = () => {  if (!currentData || currentData.length === 0) { console.log("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ kh·ªüi t·∫°o."); return; } const allAmenities = new Set(currentData.flatMap(b => b.danhSachPhong.flatMap(r => r.tienIch || []))); amenitiesContainer.innerHTML = Array.from(allAmenities).map(amenity => `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" class="amenity-checkbox rounded text-indigo-600" value="${amenity}"><span class="text-slate-600">${amenity.charAt(0).toUpperCase() + amenity.slice(1)}</span></label>`).join(''); refreshHomeView(); refreshAdminView(); updateLoginUI(); };
    tabHome.addEventListener('click', () => switchTab('home'));
    tabAdmin.addEventListener('click', () => switchTab('admin'));
    addBuildingBtn.addEventListener('click', () => openFormModal('building'));
    searchInput.addEventListener('input', filterData);
    priceFilter.addEventListener('change', filterData);
    areaFilter.addEventListener('change', filterData);
    amenitiesContainer.addEventListener('change', filterData);
    listingsContainer.addEventListener('click', e => { const roomCard = e.target.closest('.room-card'); if (roomCard?.dataset.buildingId) { const building = currentData.find(b => b.id_toa_nha === roomCard.dataset.buildingId); const room = building.danhSachPhong.find(r => r.id_phong === roomCard.dataset.roomId); showModal(building, room); } });
    modalContainer.addEventListener('click', e => { if (e.target === modalContainer || e.target.id === 'close-modal') { const modalContent = document.getElementById('modal-content'); if (modalContent) { modalContent.classList.add('scale-95'); setTimeout(() => e.currentTarget.classList.add('hidden'), 300); } else { e.currentTarget.classList.add('hidden'); } } });
    function showModal(building, room) { const modalHTML = `<div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300"><div class="p-6"><div class="flex justify-between items-start"><div><h2 class="text-2xl font-bold">${room.tenPhong}</h2><p class="text-slate-500">${building.tenToaNha}</p></div><button id="close-modal" class="text-3xl text-slate-400 hover:text-slate-600">√ó</button></div><div class="mt-4"><div id="gallery-main" class="w-full aspect-video bg-black rounded-lg flex items-center justify-center"></div><div class="flex space-x-2 mt-2 overflow-x-auto p-1">${(room.linkAnhVideo || []).map((link, index) => `<img src="${link}" data-link="${link}" class="gallery-thumbnail h-16 w-24 object-cover rounded-md ${index === 0 ? 'active' : ''}">`).join('')}</div></div><div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="font-semibold text-lg mb-2">Th√¥ng tin c∆° b·∫£n</h4><ul class="space-y-2 text-sm"><li class="flex justify-between"><span class="text-slate-600">Gi√° thu√™:</span><span class="font-bold text-xl text-indigo-600">${new Intl.NumberFormat('vi-VN').format(room.giaThue)} ƒë/th√°ng</span></li><li class="flex justify-between"><span class="text-slate-600">Di·ªán t√≠ch:</span><span class="font-medium">${room.dienTich} m¬≤</span></li><li class="flex justify-between"><span class="text-slate-600">ƒê·∫∑t c·ªçc:</span><span class="font-medium">${room.datCoc.soThang} th√°ng</span></li></ul><p class="text-xs text-slate-500 mt-2">${room.datCoc.ghiChu}</p></div><div><h4 class="font-semibold text-lg mb-2">Chi ph√≠ kh√°c</h4><ul class="text-sm divide-y divide-slate-200">${Object.entries(room.chiPhi).map(([k, v]) => `<li class="flex justify-between py-1"><span class="text-slate-600 capitalize">${k.replace(/_/g, ' ')}:</span><span class="font-medium">${v}</span></li>`).join('')}</ul></div></div><div class="mt-6"><h4 class="font-semibold text-lg mb-2">M√¥ t·∫£ chi ti·∫øt</h4><p class="text-sm text-slate-600">${(room.thongTinChiTiet || "").replace(/\n/g, '<br>')}</p></div><div class="mt-6"><h4 class="font-semibold text-lg mb-2">Ti·ªán √≠ch</h4><div class="flex flex-wrap gap-2">${(room.tienIch || []).map(a => `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-1 rounded-full">${a.charAt(0).toUpperCase() + a.slice(1)}</span>`).join('')}</div></div></div><div class="p-6 bg-slate-50 rounded-b-xl flex flex-col sm:flex-row gap-3"><a href="https://zalo.me/913238099" target="_blank" class="flex-1 text-center bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600">Chat Zalo</a><a href="https://m.me/nhatrohanoi25" target="_blank" class="flex-1 text-center bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600">Chat Messenger</a><a href="${building.viTriMap}" target="_blank" class="flex-1 text-center bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Xem b·∫£n ƒë·ªì</a></div></div>`; modalContainer.innerHTML = modalHTML; modalContainer.classList.remove('hidden'); setTimeout(() => modalContainer.querySelector('#modal-content').classList.remove('scale-95'), 10); const galleryMain = modalContainer.querySelector('#gallery-main'); const thumbnails = modalContainer.querySelectorAll('.gallery-thumbnail'); const showMedia = (link) => { galleryMain.innerHTML = link.includes('youtube.com/embed') ? `<iframe src="${link}" frameborder="0" allowfullscreen class="w-full h-full"></iframe>` : `<img src="${link}" class="w-full h-full object-contain">`;}; thumbnails.forEach(thumb => thumb.addEventListener('click', () => { thumbnails.forEach(t => t.classList.remove('active')); thumb.classList.add('active'); showMedia(thumb.dataset.link); })); if (room.linkAnhVideo && room.linkAnhVideo.length > 0) showMedia(room.linkAnhVideo[0]); else galleryMain.innerHTML = '<p class="text-white">Kh√¥ng c√≥ ·∫£nh/video.</p>'; }
    const switchTab = (tab) => { const isHome = tab === 'home'; if (!isHome && !isLoggedIn) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang Admin."); loginModalContainer.classList.remove('hidden'); return; } tabHome.classList.toggle('active', isHome); tabAdmin.classList.toggle('active', !isHome); contentHome.classList.toggle('hidden', !isHome); contentAdmin.classList.toggle('hidden', isHome); if(isHome) refreshHomeView(); else refreshAdminView(); };
    
    // --- CH·∫†Y L·∫¶N ƒê·∫¶U ---
    fetchData(); 
    updateLoginUI();
});
</script>
</body>
</html>
