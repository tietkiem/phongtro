<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m Ki·∫øm Ph√≤ng Tr·ªç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- T√≠ch h·ª£p th∆∞ vi·ªán Uploadcare -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .transition-all { transition: all 0.3s ease-in-out; }
        #modal-container.hidden, .tab-content.hidden, #form-modal-container.hidden { display: none; }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn { background-color: #eef2ff; color: #4f46e5; }
        .gallery-thumbnail { cursor: pointer; border: 2px solid transparent; }
        .gallery-thumbnail.active { border-color: #4f46e5; }
        .image-preview-item { position: relative; }
        .remove-image-btn {
            position: absolute; top: -5px; right: -5px;
            background-color: rgba(239, 68, 68, 0.8); color: white;
            border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            border: 1px solid white;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <div class="mb-8 flex justify-center border-b border-slate-200">
            <div class="flex space-x-2 p-1 bg-slate-100 rounded-lg">
                <button id="tab-home" class="tab-btn active font-semibold py-2 px-6 rounded-md transition-all">Trang Ch·ªß</button>
                <button id="tab-admin" class="tab-btn font-semibold py-2 px-6 rounded-md transition-all">Admin</button>
            </div>
        </div>

        <!-- N·ªòI DUNG TAB TRANG CH·ª¶ -->
        <div id="content-home" class="tab-content">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold">T√¨m Ph√≤ng Tr·ªç ∆Øng √ù</h1>
                <p class="text-slate-500 mt-2">N·ªÅn t·∫£ng t√¨m ki·∫øm v√† cho thu√™ ph√≤ng tr·ªç nhanh ch√≥ng, minh b·∫°ch.</p>
            </header>
            <div id="search-filters" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-slate-700 mb-1">ƒê·ªãa ch·ªâ, t√™n t√≤a nh√†</label>
                        <input type="text" id="searchInput" placeholder="VD: C·∫ßu Gi·∫•y, L√°ng H·∫°..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="priceFilter" class="block text-sm font-medium text-slate-700 mb-1">Kho·∫£ng gi√°</label>
                        <select id="priceFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="0-3000000">D∆∞·ªõi 3 tri·ªáu</option>
                            <option value="3000000-5000000">3 - 5 tri·ªáu</option>
                            <option value="5000000-7000000">5 - 7 tri·ªáu</option>
                            <option value="7000000-999999999">Tr√™n 7 tri·ªáu</option>
                        </select>
                    </div>
                    <div>
                        <label for="areaFilter" class="block text-sm font-medium text-slate-700 mb-1">Di·ªán t√≠ch (m¬≤)</label>
                        <select id="areaFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="0-20">D∆∞·ªõi 20 m¬≤</option>
                            <option value="20-30">20 - 30 m¬≤</option>
                            <option value="30-40">30 - 40 m¬≤</option>
                            <option value="40-999">Tr√™n 40 m¬≤</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 lg:col-span-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Ti·ªán √≠ch</label>
                        <div id="amenities-filter" class="flex flex-wrap gap-x-4 gap-y-2"></div>
                    </div>
                </div>
            </div>
            <div id="listings-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="no-results" class="hidden text-center py-12"><p class="text-slate-500 text-lg">Kh√¥ng t√¨m th·∫•y ph√≤ng n√†o ph√π h·ª£p.</p></div>
        </div>

        <!-- N·ªòI DUNG TAB ADMIN -->
        <div id="content-admin" class="tab-content hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold">B·∫£ng ƒêi·ªÅu Khi·ªÉn</h1>
                <p class="text-slate-500 mt-2">Qu·∫£n l√Ω danh s√°ch c√°c t√≤a nh√† v√† ph√≤ng tr·ªç.</p>
            </header>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-4">C√¥ng c·ª• nh·∫≠p nhanh t·ª´ Zalo</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <label for="zalo-input" class="block text-sm font-medium text-slate-700 mb-1">1. D√°n n·ªôi dung Zalo v√†o ƒë√¢y:</label>
                        <textarea id="zalo-input" rows="15" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="D√°n to√†n b·ªô n·ªôi dung tin nh·∫Øn..."></textarea>
                        <button id="parse-btn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all">X·ª≠ L√Ω & Xem Tr∆∞·ªõc</button>
                    </div>
                    <div id="zalo-parser-preview" class="hidden">
                        <h3 class="text-lg font-semibold mb-2">2. Xem tr∆∞·ªõc th√¥ng tin:</h3>
                        <div id="preview-content" class="p-4 bg-slate-50 border border-slate-200 rounded-lg text-sm mb-4"></div>
                        
                        <h3 class="text-lg font-semibold mb-2">3. Th√™m ·∫¢nh/Video cho t√≤a nh√† n√†y:</h3>
                        <div id="zalo-image-preview-container" class="mb-4 flex flex-wrap gap-2 p-2 border rounded-md bg-slate-50 min-h-[80px]"></div>
                        <button id="zalo-upload-btn" class="w-full bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 mb-4">Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh, Google Drive...</button>

                        <button id="add-parsed-building-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-all">4. Th√™m T√≤a Nh√† V√†o H·ªá Th·ªëng</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center my-6 pt-6 border-t">
                <h2 class="text-2xl font-semibold">Qu·∫£n l√Ω th·ªß c√¥ng</h2>
                <button id="add-building-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-all">Th√™m T√≤a Nh√† M·ªõi</button>
            </div>
            <div id="admin-listings-container" class="space-y-4"></div>
            <div class="mt-8 p-4 border-t-2 border-dashed border-amber-400 bg-amber-50 rounded-lg">
                 <h3 class="text-lg font-bold text-amber-800">L∆∞u √Ω Quan tr·ªçng:</h3>
                 <p class="text-amber-700 mt-2">Sau khi b·∫°n th√™m, s·ª≠a, ho·∫∑c x√≥a th√¥ng tin, d·ªØ li·ªáu ch·ªâ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·∫°m th·ªùi tr√™n tr√¨nh duy·ªát. ƒê·ªÉ l∆∞u thay ƒë·ªïi vƒ©nh vi·ªÖn, h√£y nh·∫•n n√∫t "T·∫£i File D·ªØ Li·ªáu" v√† l√†m theo h∆∞·ªõng d·∫´n.</p>
                 <button id="export-json-btn" class="mt-4 bg-amber-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-amber-600 transition-all">T·∫£i File D·ªØ Li·ªáu</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"></div>
    <div id="form-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60]"></div>

    <script>
    const initialData = [
      { "id_toa_nha": "building001", "tenToaNha": "Chung C∆∞ Mini L√°ng H·∫°", "diaChi": "S·ªë 123, Ng√µ 50, L√°ng H·∫°, ƒê·ªëng ƒêa, H√† N·ªôi", "viTriMap": "https://www.google.com/maps/search/?api=1&query=21.0169,105.8194", "danhSachPhong": [
          { "id_phong": "p101", "tenPhong": "Ph√≤ng 101 - Ban c√¥ng", "trangThai": "c√≤n tr·ªëng", "giaThue": 4500000, "dienTich": 25, "thongTinChiTiet": "Ph√≤ng ƒë·∫ßy ƒë·ªß n·ªôi th·∫•t cao c·∫•p, c√≥ ban c√¥ng tho√°ng m√°t, c·ª≠a s·ªï l·ªõn. View nh√¨n ra c√¥ng vi√™n.", "tienIch": ["ƒëi·ªÅu h√≤a", "n√≥ng l·∫°nh", "ban c√¥ng", "t·ªß l·∫°nh", "m√°y gi·∫∑t"], "linkAnhVideo": ["https://ucarecdn.com/a9e59524-1b28-40c8-9144-54a7a8a65b32/","https://ucarecdn.com/7a68a554-2f22-4634-8d1e-97a935588510/"], "chiPhi": { "ƒëi·ªán": "3.800ƒë/s·ªë", "n∆∞·ªõc": "100.000ƒë/ng∆∞·ªùi", "internet": "100.000ƒë/ph√≤ng", "d·ªãch v·ª•": "200.000ƒë/ph√≤ng (g·ªìm v·ªá sinh, an ninh)" }, "datCoc": { "soThang": 1, "ghiChu": "Thanh to√°n 1 th√°ng, c·ªçc 1 th√°ng. H·ª£p ƒë·ªìng t·ªëi thi·ªÉu 1 nƒÉm." } }
      ]}
    ];
    let currentData = JSON.parse(JSON.stringify(initialData));
    let parsedBuildingData = null;

    document.addEventListener('DOMContentLoaded', function() {
        const UPLOADCARE_PUBLIC_KEY = '752888ab1ddb6b4723ac'; // <-- ƒê√É C·∫¨P NH·∫¨T API KEY C·ª¶A B·∫†N
        let editingContext = null;
        
        // --- L·∫§Y C√ÅC PH·∫¶N T·ª¨ HTML ---
        const zaloInput = document.getElementById('zalo-input');
        const parseBtn = document.getElementById('parse-btn');
        const zaloParserPreview = document.getElementById('zalo-parser-preview');
        const previewContent = document.getElementById('preview-content');
        const zaloImagePreviewContainer = document.getElementById('zalo-image-preview-container');
        const zaloUploadBtn = document.getElementById('zalo-upload-btn');
        const addParsedBuildingBtn = document.getElementById('add-parsed-building-btn');
        // ... c√°c element kh√°c
        const tabHome = document.getElementById('tab-home');
        const tabAdmin = document.getElementById('tab-admin');
        const contentHome = document.getElementById('content-home');
        const contentAdmin = document.getElementById('content-admin');
        const searchInput = document.getElementById('searchInput');
        const priceFilter = document.getElementById('priceFilter');
        const areaFilter = document.getElementById('areaFilter');
        const amenitiesContainer = document.getElementById('amenities-filter');
        const listingsContainer = document.getElementById('listings-container');
        const noResultsDiv = document.getElementById('no-results');
        const modalContainer = document.getElementById('modal-container');
        const adminListingsContainer = document.getElementById('admin-listings-container');
        const addBuildingBtn = document.getElementById('add-building-btn');
        const formModalContainer = document.getElementById('form-modal-container');
        const exportJsonBtn = document.getElementById('export-json-btn');

        // --- C√îNG C·ª§ NH·∫¨P NHANH T·ª™ ZALO (v5.1) ---
        parseBtn.addEventListener('click', () => {
            const text = zaloInput.value;
            if (!text.trim()) { alert('Vui l√≤ng d√°n n·ªôi dung Zalo v√†o √¥.'); return; }
            try {
                const building = { id_toa_nha: `building_${Date.now()}`, tenToaNha: "", diaChi: "", viTriMap: "", danhSachPhong: [], tempImageLinks: [] };
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const findLine = (keyword) => lines.find(l => l.toLowerCase().includes(keyword.toLowerCase()));
                const getVal = (line, separator = ':') => line ? line.split(separator)[1]?.trim() : "";
                
                building.diaChi = getVal(findLine('ƒê·ªãa ch·ªâ:')) || 'Ch∆∞a x√°c ƒë·ªãnh';
                building.tenToaNha = `T√≤a nh√† t·∫°i ${building.diaChi.split(',')[0]}`;
                const dienTich = parseInt(findLine('Di·ªán t√≠ch:')?.match(/(\d+)/)?.[0] || '25');
                const thongTinChiTiet = getVal(findLine('Full n·ªôi th·∫•t')) || "N·ªôi th·∫•t ƒë·∫ßy ƒë·ªß.";
                const tienIch = ['ƒëi·ªÅu h√≤a', 'n√≥ng l·∫°nh', 'b·∫øp', 't·ªß l·∫°nh', 'm√°y gi·∫∑t', 'ban c√¥ng', 'thang m√°y'].filter(item => text.toLowerCase().includes(item));
                
                let chiPhi = {};
                const phiDvLine = findLine('Ph√≠ dv:');
                if (phiDvLine) {
                    const feesText = getVal(phiDvLine);
                    const normalizeFee = (str) => str ? str.replace('k', '.000ƒë') : '0ƒë';
                    chiPhi['ƒëi·ªán'] = normalizeFee(feesText.match(/ƒêi·ªán\s*([\d.]+[kK])/)?.[1]) + '/s·ªë';
                    chiPhi['n∆∞·ªõc'] = normalizeFee(feesText.match(/N∆∞·ªõc\s*([\d.]+[kK])/)?.[1]) + '/ng∆∞·ªùi';
                    chiPhi['internet'] = normalizeFee(feesText.match(/wifi\s*([\d.]+[kK])/)?.[1]) + '/ph√≤ng';
                    chiPhi['d·ªãch v·ª•'] = normalizeFee(feesText.match(/D·ªãch v·ª• chung\s*([\d.]+[kK])/)?.[1]) + '/ng∆∞·ªùi';
                }

                const cocLine = findLine('ƒê√≥ng');
                let datCoc = { soThang: 1, ghiChu: getVal(cocLine, 'üëâ') || "H·ª£p ƒë·ªìng 6-12 th√°ng" };
                const cocMatch = cocLine?.match(/ƒê√≥ng\s*(\d)c·ªçc(\d)/);
                if (cocMatch) datCoc.soThang = parseInt(cocMatch[2]);
                
                lines.filter(l => l.toLowerCase().includes('gi√°')).forEach(line => {
                    const priceMatch = line.match(/Gi√°\s*-?\s*(\d+tr\d*)/);
                    if (!priceMatch) return;
                    const giaThue = parseFloat(priceMatch[1].replace('tr', '.')) * 1000000;
                    const roomCodes = line.split(':')[1]?.match(/[a-zA-Z]?\d+/g) || [];
                    roomCodes.forEach(code => {
                        building.danhSachPhong.push({
                            id_phong: `p_${code}_${Date.now() % 10000 + code}`, tenPhong: `Ph√≤ng ${code}`, trangThai: "c√≤n tr·ªëng",
                            giaThue, dienTich, thongTinChiTiet, tienIch, chiPhi, datCoc, linkAnhVideo: []
                        });
                    });
                });
                
                parsedBuildingData = building;
                renderPreview(building);
                zaloParserPreview.classList.remove('hidden');
                zaloImagePreviewContainer.innerHTML = ''; // Reset ·∫£nh
            } catch (error) {
                alert('X·ª≠ l√Ω d·ªØ li·ªáu th·∫•t b·∫°i! Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng vƒÉn b·∫£n.');
                console.error("Parse Zalo Error:", error);
            }
        });

        function renderPreview(building) {
            previewContent.innerHTML = `
                <p><strong>T√™n t√≤a nh√†:</strong> ${building.tenToaNha}</p>
                <p><strong>T·ªïng s·ªë ph√≤ng s·∫Ω th√™m:</strong> ${building.danhSachPhong.length} ph√≤ng</p>`;
        }
        
        zaloUploadBtn.addEventListener('click', () => {
            if (!parsedBuildingData) { alert("Vui l√≤ng x·ª≠ l√Ω d·ªØ li·ªáu Zalo tr∆∞·ªõc."); return; }
            const widget = uploadcare.openDialog(null, {
                publicKey: UPLOADCARE_PUBLIC_KEY, multiple: true, tabs: 'file url gdrive facebook instagram',
            });
            widget.done(fileGroup => {
                fileGroup.promise().then(groupInfo => {
                    groupInfo.files.forEach(file => {
                        parsedBuildingData.tempImageLinks.push(file.cdnUrl);
                        addImagePreview(zaloImagePreviewContainer, file.cdnUrl, true);
                    });
                });
            });
        });

        addParsedBuildingBtn.addEventListener('click', () => {
            if (parsedBuildingData) {
                // G√°n c√°c link ·∫£nh ƒë√£ upload cho t·∫•t c·∫£ c√°c ph√≤ng
                parsedBuildingData.danhSachPhong.forEach(room => {
                    room.linkAnhVideo = [...parsedBuildingData.tempImageLinks];
                });
                delete parsedBuildingData.tempImageLinks; // X√≥a thu·ªôc t√≠nh t·∫°m
                
                currentData.unshift(parsedBuildingData);
                parsedBuildingData = null;
                zaloParserPreview.classList.add('hidden');
                zaloInput.value = '';
                alert('ƒê√£ th√™m t√≤a nh√† m·ªõi th√†nh c√¥ng!');
                refreshAdminView();
                refreshHomeView();
            }
        });

        // --- QU·∫¢N L√ù TH·ª¶ C√îNG & FORM ---
        function openFormModal(type, data = {}, context = {}) {
            editingContext = { type, ...context };
            const isBuilding = type === 'building';
            const fields = getFormFields(type);
            const title = isBuilding ? (data.id_toa_nha ? 'S·ª≠a T√≤a Nh√†' : 'Th√™m T√≤a Nh√†') : (data.id_phong ? 'S·ª≠a Ph√≤ng' : 'Th√™m Ph√≤ng');
            
            const formModalContent = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <form id="admin-form" class="p-6 space-y-4">
                        <h2 class="text-2xl font-bold mb-4">${title}</h2>
                        <div id="form-fields">${fields.map(field => renderField(field, data)).join('')}</div>
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" class="cancel-form-btn bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">H·ªßy</button>
                            <button type="submit" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700">L∆∞u</button>
                        </div>
                    </form>
                </div>`;
            formModalContainer.innerHTML = formModalContent;
            formModalContainer.classList.remove('hidden');
            formModalContainer.querySelector('.cancel-form-btn').addEventListener('click', () => formModalContainer.classList.add('hidden'));
            formModalContainer.querySelector('#admin-form').addEventListener('submit', handleFormSubmit);

            if (type === 'room') {
                const uploadBtn = document.getElementById('upload-btn');
                uploadBtn.addEventListener('click', () => {
                    const widget = uploadcare.openDialog(null, {
                        publicKey: UPLOADCARE_PUBLIC_KEY, multiple: true, tabs: 'file url gdrive facebook instagram',
                    });
                    widget.done(fileGroup => {
                        fileGroup.promise().then(groupInfo => {
                            const previewContainer = document.getElementById('image-preview-container');
                            const hiddenInput = document.getElementById('linkAnhVideo');
                            let currentUrls = hiddenInput.value ? hiddenInput.value.split(',') : [];
                            groupInfo.files.forEach(file => {
                                if (!currentUrls.includes(file.cdnUrl)) {
                                    currentUrls.push(file.cdnUrl);
                                    addImagePreview(previewContainer, file.cdnUrl, false);
                                }
                            });
                            hiddenInput.value = currentUrls.join(',');
                        });
                    });
                });
            }
        }

        function getFormFields(type) {
            if (type === 'building') return [
                { id: 'tenToaNha', label: 'T√™n t√≤a nh√†', type: 'text' }, { id: 'diaChi', label: 'ƒê·ªãa ch·ªâ', type: 'text' }, { id: 'viTriMap', label: 'Link Google Map', type: 'text' }
            ];
            return [
                { id: 'tenPhong', label: 'T√™n ph√≤ng', type: 'text' }, { id: 'trangThai', label: 'Tr·∫°ng th√°i', type: 'select', options: ['c√≤n tr·ªëng', 'ƒë√£ thu√™'] },
                { id: 'giaThue', label: 'Gi√° thu√™ (VNƒê)', type: 'number' }, { id: 'dienTich', label: 'Di·ªán t√≠ch (m¬≤)', type: 'number' },
                { id: 'thongTinChiTiet', label: 'M√¥ t·∫£ chi ti·∫øt', type: 'textarea' }, { id: 'tienIch', label: 'Ti·ªán √≠ch (c√°ch nhau b·ªüi d·∫•u ph·∫©y)', type: 'text' },
                { id: 'linkAnhVideo', label: '·∫¢nh & Video', type: 'uploader' },
                { id: 'chiPhi_dien', label: 'Ph√≠ ƒëi·ªán', type: 'text' }, { id: 'chiPhi_nuoc', label: 'Ph√≠ n∆∞·ªõc', type: 'text' },
                { id: 'chiPhi_internet', label: 'Ph√≠ Internet', type: 'text' }, { id: 'chiPhi_dichVu', label: 'Ph√≠ d·ªãch v·ª•', type: 'text' },
                { id: 'datCoc_soThang', label: 'C·ªçc (s·ªë th√°ng)', type: 'number' }, { id: 'datCoc_ghiChu', label: 'Ghi ch√∫ c·ªçc', type: 'text' }
            ];
        }

        function renderField(field, data) {
            const value = getNestedValue(field.id, data);
            switch (field.type) {
                case 'textarea': return `<label class="block"><span class="text-slate-700">${field.label}</span><textarea id="${field.id}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" rows="3">${value}</textarea></label>`;
                case 'select': return `<label class="block"><span class="text-slate-700">${field.label}</span><select id="${field.id}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">${field.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('')}</select></label>`;
                case 'uploader':
                    return `<div>
                                <span class="text-slate-700">${field.label}</span>
                                <div id="image-preview-container" class="mt-2 flex flex-wrap gap-2 p-2 border rounded-md bg-slate-50 min-h-[80px]">
                                    ${value.map(url => `<div class="image-preview-item w-20 h-20"><img src="${url}-/preview/100x100/" class="w-full h-full object-cover rounded-md"><span class="remove-image-btn" data-url="${url}">&times;</span></div>`).join('')}
                                </div>
                                <input type="hidden" id="linkAnhVideo" value="${value.join(',')}">
                                <button type="button" id="upload-btn" class="mt-2 w-full bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">Th√™m ·∫¢nh/Video...</button>
                            </div>`;
                default: return `<label class="block"><span class="text-slate-700">${field.label}</span><input type="${field.type}" id="${field.id}" value="${value}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></label>`;
            }
        }

        function addImagePreview(container, url, isZaloPreview) {
            const item = document.createElement('div');
            item.className = 'image-preview-item w-20 h-20';
            item.innerHTML = `<img src="${url}-/preview/100x100/" class="w-full h-full object-cover rounded-md"><span class="remove-image-btn" data-url="${url}" data-zalo="${isZaloPreview}">&times;</span>`;
            container.appendChild(item);
        }

        document.addEventListener('click', e => {
            if (e.target.classList.contains('remove-image-btn')) {
                const urlToRemove = e.target.dataset.url;
                const isZalo = e.target.dataset.zalo === 'true';
                if (isZalo) {
                    parsedBuildingData.tempImageLinks = parsedBuildingData.tempImageLinks.filter(url => url !== urlToRemove);
                } else {
                    const hiddenInput = document.getElementById('linkAnhVideo');
                    let urls = hiddenInput.value.split(',');
                    urls = urls.filter(url => url !== urlToRemove);
                    hiddenInput.value = urls.join(',');
                }
                e.target.parentElement.remove();
            }
        });
        
        function getNestedValue(path, obj) {
            const keys = path.split('_');
            let value = obj;
            for (let key of keys) value = value?.[key];
            return value || (path.includes('linkAnhVideo') || path.includes('tienIch') ? [] : '');
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('_');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                current = current[keys[i]] = current[keys[i]] || {};
            }
            const finalKey = keys[keys.length - 1];
            if (path === 'tienIch' || path === 'linkAnhVideo') {
                current[finalKey] = value ? value.split(',').map(s => s.trim()).filter(Boolean) : [];
            } else {
                current[finalKey] = value;
            }
        }
        
        function handleFormSubmit(e) { /* T∆∞∆°ng t·ª± v4, nh∆∞ng l·∫•y value t·ª´ hidden input cho ·∫£nh */
            e.preventDefault();
            const data = {};
            const fields = getFormFields(editingContext.type);
            fields.forEach(field => setNestedValue(data, field.id, document.getElementById(field.id).value));

            if (editingContext.type === 'building') {
                if (editingContext.buildingId) {
                    const index = currentData.findIndex(b => b.id_toa_nha === editingContext.buildingId);
                    currentData[index] = { ...currentData[index], ...data };
                } else {
                    data.id_toa_nha = `building_${Date.now()}`;
                    data.danhSachPhong = [];
                    currentData.unshift(data);
                }
            } else if (editingContext.type === 'room') {
                const building = currentData.find(b => b.id_toa_nha === editingContext.buildingId);
                if (editingContext.roomId) {
                    const index = building.danhSachPhong.findIndex(r => r.id_phong === editingContext.roomId);
                    building.danhSachPhong[index] = { ...building.danhSachPhong[index], ...data };
                } else {
                    data.id_phong = `room_${Date.now()}`;
                    building.danhSachPhong.push(data);
                }
            }
            formModalContainer.classList.add('hidden');
            refreshAdminView();
            refreshHomeView();
        }

        function refreshAdminView() { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            adminListingsContainer.innerHTML = currentData.map(building => `
                <div class="admin-card bg-white p-4 rounded-lg shadow border-2 border-transparent transition-all">
                    <div class="flex justify-between items-start">
                        <div><h3 class="text-xl font-bold">${building.tenToaNha}</h3><p class="text-sm text-slate-500">${building.diaChi}</p></div>
                        <div class="space-x-2 flex-shrink-0 ml-4"><button class="edit-building-btn text-blue-600 hover:underline" data-building-id="${building.id_toa_nha}">S·ª≠a</button><button class="delete-building-btn text-red-600 hover:underline" data-building-id="${building.id_toa_nha}">X√≥a</button></div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold">C√°c ph√≤ng:</h4>
                        ${building.danhSachPhong.map(room => `
                            <div class="flex justify-between items-center p-2 bg-slate-50 rounded mt-2">
                                <span>${room.tenPhong} - ${room.trangThai}</span>
                                <div class="space-x-2"><button class="edit-room-btn text-sm text-blue-600 hover:underline" data-building-id="${building.id_toa_nha}" data-room-id="${room.id_phong}">S·ª≠a</button><button class="delete-room-btn text-sm text-red-600 hover:underline" data-building-id="${building.id_toa_nha}" data-room-id="${room.id_phong}">X√≥a</button></div>
                            </div>`).join('') || '<p class="text-sm text-slate-400 p-2">Ch∆∞a c√≥ ph√≤ng n√†o.</p>'}
                        <button class="add-room-btn mt-3 text-sm w-full text-center bg-slate-200 hover:bg-slate-300 py-2 rounded" data-building-id="${building.id_toa_nha}">+ Th√™m ph√≤ng m·ªõi</button>
                    </div>
                </div>`).join('');
        }
        adminListingsContainer.addEventListener('click', e => { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            const { buildingId, roomId } = e.target.dataset;
            if (e.target.matches('.edit-building-btn')) openFormModal('building', currentData.find(b => b.id_toa_nha === buildingId), { buildingId });
            if (e.target.matches('.delete-building-btn')) {
                if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t√≤a nh√† n√†y?`)) {
                    currentData = currentData.filter(b => b.id_toa_nha !== buildingId);
                    refreshAdminView(); refreshHomeView();
                }
            }
            if (e.target.matches('.add-room-btn')) openFormModal('room', {}, { buildingId });
            if (e.target.matches('.edit-room-btn')) {
                const room = currentData.find(b => b.id_toa_nha === buildingId).danhSachPhong.find(r => r.id_phong === roomId);
                openFormModal('room', room, { buildingId, roomId });
            }
            if (e.target.matches('.delete-room-btn')) {
                 if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng n√†y?`)) {
                    const building = currentData.find(b => b.id_toa_nha === buildingId);
                    building.danhSachPhong = building.danhSachPhong.filter(r => r.id_phong !== roomId);
                    refreshAdminView(); refreshHomeView();
                }
            }
        });
        const refreshHomeView = () => filterData();
        function filterData() { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            const keyword = searchInput.value.toLowerCase();
            const priceRange = priceFilter.value ? priceFilter.value.split('-').map(Number) : null;
            const areaRange = areaFilter.value ? areaFilter.value.split('-').map(Number) : null;
            const selectedAmenities = Array.from(document.querySelectorAll('.amenity-checkbox:checked')).map(cb => cb.value);

            const filtered = currentData.map(building => {
                const matchingRooms = building.danhSachPhong.filter(room => {
                    if (keyword && !`${building.tenToaNha} ${building.diaChi}`.toLowerCase().includes(keyword)) return false;
                    if (priceRange && (room.giaThue < priceRange[0] || room.giaThue > priceRange[1])) return false;
                    if (areaRange && (room.dienTich < areaRange[0] || room.dienTich > areaRange[1])) return false;
                    if (selectedAmenities.length > 0 && !selectedAmenities.every(a => (room.tienIch || []).includes(a))) return false;
                    return true;
                });
                return matchingRooms.length > 0 ? { ...building, danhSachPhong: matchingRooms } : null;
            }).filter(Boolean);
            renderListings(filtered);
        }
        function renderListings(filteredData) { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            listingsContainer.innerHTML = '';
            noResultsDiv.classList.toggle('hidden', filteredData.length > 0);
            filteredData.forEach(building => {
                const firstAvailableRoom = building.danhSachPhong.find(r => r.trangThai === 'c√≤n tr·ªëng' && r.linkAnhVideo && r.linkAnhVideo.length > 0);
                const previewImage = firstAvailableRoom?.linkAnhVideo[0] || 'https://placehold.co/400x300/e2e8f0/64748b?text=Kh√¥ng+c√≥+·∫£nh';
                const isYoutube = previewImage.includes('youtube.com/embed');
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all flex flex-col';
                card.innerHTML = `
                    <div class="relative">${isYoutube ? `<div class="w-full h-48 bg-black flex items-center justify-center text-white font-bold">VIDEO PREVIEW</div>` : `<img src="${previewImage.replace(/\/$/, '')}/-/preview/400x300/" alt="·∫¢nh t√≤a nh√†" class="w-full h-48 object-cover">`}</div>
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-lg font-bold">${building.tenToaNha}</h3><p class="text-sm text-slate-500 mt-1 flex-grow">${building.diaChi}</p>
                        <p class="text-sm text-indigo-600 font-semibold mt-2">C√≤n ${building.danhSachPhong.filter(r => r.trangThai === 'c√≤n tr·ªëng').length} ph√≤ng tr·ªëng</p>
                    </div>
                    <div class="bg-slate-50 max-h-48 overflow-y-auto">${building.danhSachPhong.map(room => `<div class="room-item p-3 border-t border-slate-100 ${room.trangThai === 'c√≤n tr·ªëng' ? 'cursor-pointer hover:bg-slate-50' : 'cursor-not-allowed opacity-60'}" ${room.trangThai === 'c√≤n tr·ªëng' ? `data-building-id="${building.id_toa_nha}" data-room-id="${room.id_phong}"` : ''}><div class="flex justify-between items-center"><p class="font-semibold">${room.tenPhong}</p><span class="text-xs font-medium px-2 py-1 rounded-full ${room.trangThai === 'c√≤n tr·ªëng' ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-200 text-slate-500'}">${room.trangThai}</span></div><div class="text-sm text-slate-500 mt-1"><span>${(room.giaThue / 1000000).toFixed(2).replace('.00','')} tri·ªáu/th√°ng</span> - <span>${room.dienTich} m¬≤</span></div></div>`).join('')}</div>`;
                listingsContainer.appendChild(card);
            });
        }
        function showModal(buildingId, roomId) { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            const building = currentData.find(b => b.id_toa_nha === buildingId);
            const room = building.danhSachPhong.find(r => r.id_phong === roomId);
            const modalHTML = `
                <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
                    <div class="p-6">
                        <div class="flex justify-between items-start"><div><h2 class="text-2xl font-bold">${room.tenPhong}</h2><p class="text-slate-500">${building.tenToaNha}</p></div><button id="close-modal" class="text-3xl text-slate-400 hover:text-slate-600">&times;</button></div>
                        <div class="mt-4"><div id="gallery-main" class="w-full aspect-video bg-black rounded-lg flex items-center justify-center"></div><div class="flex space-x-2 mt-2 overflow-x-auto p-1">${(room.linkAnhVideo || []).map((link, index) => `<img src="${link.replace(/\/$/, '')}/-/preview/100x100/" data-link="${link}" class="gallery-thumbnail h-16 w-24 object-cover rounded-md ${index === 0 ? 'active' : ''}">`).join('')}</div></div>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><h4 class="font-semibold text-lg mb-2">Th√¥ng tin c∆° b·∫£n</h4><ul class="space-y-2 text-sm"><li class="flex justify-between"><span class="text-slate-600">Gi√° thu√™:</span><span class="font-bold text-xl text-indigo-600">${new Intl.NumberFormat('vi-VN').format(room.giaThue)} ƒë/th√°ng</span></li><li class="flex justify-between"><span class="text-slate-600">Di·ªán t√≠ch:</span><span class="font-medium">${room.dienTich} m¬≤</span></li><li class="flex justify-between"><span class="text-slate-600">ƒê·∫∑t c·ªçc:</span><span class="font-medium">${room.datCoc.soThang} th√°ng</span></li></ul><p class="text-xs text-slate-500 mt-2">${room.datCoc.ghiChu}</p></div>
                            <div><h4 class="font-semibold text-lg mb-2">Chi ph√≠ kh√°c</h4><ul class="text-sm divide-y divide-slate-200">${Object.entries(room.chiPhi).map(([k, v]) => `<li class="flex justify-between py-1"><span class="text-slate-600 capitalize">${k}:</span><span class="font-medium">${v}</span></li>`).join('')}</ul></div>
                        </div>
                        <div class="mt-6"><h4 class="font-semibold text-lg mb-2">M√¥ t·∫£ chi ti·∫øt</h4><p class="text-sm text-slate-600">${room.thongTinChiTiet}</p></div>
                        <div class="mt-6"><h4 class="font-semibold text-lg mb-2">Ti·ªán √≠ch</h4><div class="flex flex-wrap gap-2">${(room.tienIch || []).map(a => `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-1 rounded-full">${a.charAt(0).toUpperCase() + a.slice(1)}</span>`).join('')}</div></div>
                    </div>
                    <div class="p-6 bg-slate-50 rounded-b-xl flex flex-col sm:flex-row gap-3"><a href="https://zalo.me/0987654321" target="_blank" class="flex-1 text-center bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600">Chat Zalo</a><a href="https://m.me/YourFacebookID" target="_blank" class="flex-1 text-center bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600">Chat Messenger</a><a href="${building.viTriMap}" target="_blank" class="flex-1 text-center bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Xem b·∫£n ƒë·ªì</a></div>
                </div>`;
            modalContainer.innerHTML = modalHTML;
            modalContainer.classList.remove('hidden');
            setTimeout(() => modalContainer.querySelector('#modal-content').classList.remove('scale-95'), 10);
            
            const galleryMain = modalContainer.querySelector('#gallery-main');
            const thumbnails = modalContainer.querySelectorAll('.gallery-thumbnail');
            const showMedia = (link) => galleryMain.innerHTML = `<img src="${link}" class="w-full h-full object-contain">`;
            thumbnails.forEach(thumb => thumb.addEventListener('click', () => {
                thumbnails.forEach(t => t.classList.remove('active'));
                thumb.classList.add('active');
                showMedia(thumb.dataset.link);
            }));
            if (room.linkAnhVideo && room.linkAnhVideo.length > 0) showMedia(room.linkAnhVideo[0]);
        }
        
        const initializeAll = () => { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            const allAmenities = new Set(currentData.flatMap(b => b.danhSachPhong.flatMap(r => r.tienIch || [])));
            amenitiesContainer.innerHTML = Array.from(allAmenities).map(amenity => `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" class="amenity-checkbox rounded text-indigo-600" value="${amenity}"><span class="text-slate-600">${amenity.charAt(0).toUpperCase() + amenity.slice(1)}</span></label>`).join('');
            refreshHomeView();
            refreshAdminView();
        };
        tabHome.addEventListener('click', () => switchTab('home'));
        tabAdmin.addEventListener('click', () => switchTab('admin'));
        addBuildingBtn.addEventListener('click', () => openFormModal('building'));
        searchInput.addEventListener('input', filterData);
        priceFilter.addEventListener('change', filterData);
        areaFilter.addEventListener('change', filterData);
        amenitiesContainer.addEventListener('change', filterData);
        listingsContainer.addEventListener('click', e => {
            const roomItem = e.target.closest('.room-item');
            if (roomItem?.dataset.buildingId) showModal(roomItem.dataset.buildingId, roomItem.dataset.roomId);
        });
        modalContainer.addEventListener('click', e => {
            if (e.target === modalContainer) e.currentTarget.classList.add('hidden');
        });
        exportJsonBtn.addEventListener('click', () => { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            const dataStr = `const initialData = ${JSON.stringify(currentData, null, 4)};`;
            const dataBlob = new Blob([dataStr], {type: "text/javascript"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'data.js';
            link.click();
            URL.revokeObjectURL(url);
            alert("ƒê√£ t·∫£i file 'data.js'. Vui l√≤ng d√πng file n√†y ƒë·ªÉ thay th·∫ø d·ªØ li·ªáu trong file HTML c·ªßa b·∫°n, sau ƒë√≥ c·∫≠p nh·∫≠t l√™n GitHub.");
        });
        const switchTab = (tab) => { /* Gi·ªØ nguy√™n t·ª´ v4 */ 
            const isHome = tab === 'home';
            tabHome.classList.toggle('active', isHome);
            tabAdmin.classList.toggle('active', !isHome);
            contentHome.classList.toggle('hidden', !isHome);
            contentAdmin.classList.toggle('hidden', isHome);
            if(isHome) refreshHomeView(); else refreshAdminView();
        };

        // --- CH·∫†Y L·∫¶N ƒê·∫¶U ---
        initializeAll();
    });
    </script>
</body>
</html>
